@using SkillBuilder.Models.ViewModels
@model UserProfileViewModel

<style>
    /* --- Container --- */
    .epf-container-wrapper {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
        position: relative;
        min-height: 580px;
    }

    .epf-left-panel {
        flex: 1;
        max-width: calc(100% - 200px);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .epf-right-panel {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        width: 180px;
        position: absolute;
        right: 0;
        top: 0;
    }

    .epf-field {
        display: flex;
        flex-direction: column;
    }

        .epf-field label {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

    .epf-input {
        padding: 0.5rem 0.75rem;
        border: 1px solid #c0c0c0;
        border-radius: 8px;
        font-size: 0.95rem;
        width: 100%;
        margin-bottom: 1rem;
    }

    .epf-submit-btn {
        margin-top: 1rem;
        padding: 0.75rem 1.25rem;
        font-size: 0.95rem;
        font-weight: bold;
        background-color: #344AEA;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease;
    }

        .epf-submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

    .epf-avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ddd;
        background-color: #f0f0f8;
    }

    .epf-change-avatar-btn,
    .epf-toggle-password-btn {
        background-color: #344AEA;
        color: white;
        border: none;
        padding: 0.7rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        text-align: center;
        transition: background 0.2s ease;
    }

        .epf-change-avatar-btn:hover,
        .epf-toggle-password-btn:hover {
            background-color: #2b36c5;
        }

    /* --- Password section --- */
    .epf-password-section {
        display: none;
        flex-direction: column;
        gap: 1rem;
    }

    .epf-password-field {
        position: relative;
        display: flex;
        flex-direction: column;
    }

        .epf-password-field input {
            padding-right: 2.5rem;
        }

    .epf-toggle-eye {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        cursor: pointer;
    }

    /* --- Modal --- */
    .epf-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .epf-modal {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        width: 300px;
        text-align: center;
    }

        .epf-modal button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

    .epf-modal-confirm {
        background-color: #344AEA;
        color: white;
    }

    .epf-modal-cancel {
        background-color: #ccc;
        color: #333;
        margin-left: 1rem;
    }

    .epf-warning {
        color: red;
        font-size: 0.8rem;
        display: none;
        margin-bottom: 1rem;
        margin-top: -1rem;
    }

    .password-checklist {
        font-size: 0.8rem;
        margin-top: 0.5rem;
        color: gray;
    }
</style>

@if (TempData["ErrorMessage"] != null)
{
    <div style="padding:10px; background-color:#f8d7da; color:#721c24; border-radius:5px; margin-bottom:10px;">
        @TempData["ErrorMessage"]
    </div>
}

<div class="epf-container-wrapper">
    <!-- Left Panel -->
    <div class="epf-left-panel">
        <form class="epf-form" method="post" enctype="multipart/form-data" asp-controller="UserProfile" asp-action="EditProfile">

            <!-- Email -->
            <div class="epf-email-section" id="epf-email-section" style="display:none;">
                <div class="epf-field">
                    <label for="Email">Email</label>
                    <input type="email" id="Email" name="Email" class="epf-input" value="@Model.User.Email" />
                    <p class="epf-warning" id="epf-email-warning">⚠️ Please enter a valid email.</p>
                    <p class="epf-warning" id="epf-email-exists-warning" style="display:none;">⚠️ This email is already in use.</p>
                </div>
            </div>

            <!-- Change Email Warning Modal -->
            <div class="epf-modal-overlay" id="epf-email-modal-overlay">
                <div class="epf-modal">
                    <p>Are you want to edit your Email? Upon successful editing of email you will become unverified again and must verify through Email. We will send the verification immediately.</p>
                    <button type="button" class="epf-modal-confirm" id="epf-email-confirm">Yes, proceed</button>
                    <button type="button" class="epf-modal-cancel" id="epf-email-cancel">Cancel</button>
                </div>
            </div>

            <!-- First Name -->
            <div class="epf-field">
                <label for="FirstName">First Name</label>
                <input type="text" id="FirstName" name="FirstName" class="epf-input" value="@Model.User.FirstName" required />
                <p class="epf-warning" id="epf-firstname-warning">⚠️ First Name must contain letters only.</p>
            </div>

            <!-- Last Name -->
            <div class="epf-field">
                <label for="LastName">Last Name</label>
                <input type="text" id="LastName" name="LastName" class="epf-input" value="@Model.User.LastName" required />
                <p class="epf-warning" id="epf-lastname-warning">⚠️ Last Name must contain letters only.</p>
            </div>

            <!-- Birth Date -->
            <div class="epf-field">
                <label for="BirthDate">Birth Date</label>
                <input type="date" id="BirthDate" name="BirthDate" max="" class="epf-input"
                       value="@(Model.User.BirthDate.HasValue? Model.User.BirthDate.Value.ToString("yyyy-MM-dd") : "")" />
            </div>

            <!-- Password Section -->
            <div class="epf-password-section" id="epf-password-section">
                <div class="epf-password-field">
                    <label for="CurrentPassword">Old Password</label>
                    <input type="password" id="CurrentPassword" name="CurrentPassword" class="epf-input" placeholder="Enter current password" />
                    <span class="epf-toggle-eye" onclick="togglePassword('CurrentPassword', this)">👁️‍🗨️</span>
                    <p class="epf-warning" id="epf-current-warning" style="display:none;">⚠️ Wrong password</p>
                </div>
                <div class="epf-password-field">
                    <label for="NewPassword">New Password</label>
                    <input type="password" id="NewPassword" name="NewPassword" class="epf-input" placeholder="Enter new password" />
                    <span class="epf-toggle-eye" onclick="togglePassword('NewPassword', this)">👁️‍🗨️</span>
                    <!-- Password checklist -->
                    <div class="password-checklist" id="epf-password-checklist">
                        <p id="epf-check-length">❌ At least 8 characters</p>
                        <p id="epf-check-uppercase">❌ At least one uppercase letter</p>
                        <p id="epf-check-number">❌ At least one number</p>
                        <p id="epf-check-symbol">❌ At least one symbol</p>
                    </div>
                </div>
                <div class="epf-password-field">
                    <label for="ConfirmPassword">Confirm Password</label>
                    <input type="password" id="ConfirmPassword" name="ConfirmPassword" class="epf-input" placeholder="Confirm new password" />
                    <span class="epf-toggle-eye" onclick="togglePassword('ConfirmPassword', this)">👁️‍🗨️</span>
                    <p class="epf-warning" id="epf-confirm-warning">⚠️ Passwords do not match.</p>
                </div>
            </div>

            <!-- Hidden avatar input (inside form) -->
            <input type="file" id="UserAvatar" name="UserAvatar" accept="image/*" style="display:none;" />

            <button type="submit" class="epf-submit-btn" id="epf-submit-btn" disabled>Save Changes</button>

            <!-- Modal -->
            <div class="epf-modal-overlay" id="epf-modal-overlay">
                <div class="epf-modal">
                    <p>Are you sure you want to save changes?</p>
                    <button type="button" class="epf-modal-confirm" id="epf-modal-confirm">Yes</button>
                    <button type="button" class="epf-modal-cancel" id="epf-modal-cancel">Cancel</button>
                </div>
            </div>

            <!-- Right Panel (visually right) -->
            <div class="epf-right-panel">
                <label>Profile Picture</label>
                <img src="@Model.User.UserAvatar" class="epf-avatar-preview" id="epf-avatar-preview" />
                <button type="button" class="epf-change-avatar-btn" id="epf-change-avatar-btn">Change Avatar</button>
                <button type="button" class="epf-toggle-password-btn" id="epf-toggle-email-btn">Change Email</button>
                <button type="button" class="epf-toggle-password-btn" id="epf-toggle-password-btn">Change Password</button>
            </div>

        </form>
    </div>
</div>

<script>

    setTimeout(() => {
        document.querySelectorAll('.temp-message').forEach(el => el.remove());
    }, 5000);

    const avatarInput = document.getElementById('UserAvatar');
    const avatarPreview = document.getElementById('epf-avatar-preview');
    const changeAvatarBtn = document.getElementById('epf-change-avatar-btn');
    const passwordToggleBtn = document.getElementById('epf-toggle-password-btn');
    const passwordSection = document.getElementById('epf-password-section');
    const submitBtn = document.getElementById('epf-submit-btn');
    const form = document.querySelector('.epf-form');

    const modalOverlay = document.getElementById('epf-modal-overlay');
    const modalConfirm = document.getElementById('epf-modal-confirm');
    const modalCancel = document.getElementById('epf-modal-cancel');

    // Inputs and warnings
    const emailInput = document.getElementById('Email');
    const firstNameInput = document.getElementById('FirstName');
    const lastNameInput = document.getElementById('LastName');
    const birthDateInput = document.getElementById('BirthDate');
    const today = new Date().toISOString().split('T')[0]; // yyyy-mm-dd
    birthDateInput.setAttribute('max', today);
    const currentPassword = document.getElementById('CurrentPassword'); // Added
    const currentWarning = document.getElementById('epf-current-warning'); // Add <p id="epf-current-warning">⚠️ Wrong password</p> in your HTML
    const newPassword = document.getElementById('NewPassword');
    const confirmPassword = document.getElementById('ConfirmPassword');
    const confirmWarning = document.getElementById('epf-confirm-warning');
    const passwordChecklist = document.getElementById('epf-password-checklist');

    let oldPasswordTimeout;
    currentPassword.addEventListener('input', () => {
        clearTimeout(oldPasswordTimeout);
        oldPasswordTimeout = setTimeout(() => {
            const value = currentPassword.value;
            if (!value) {
                currentWarning.style.display = 'none';
                return;
            }

            fetch(`/UserProfile/VerifyOldPassword?oldPassword=${encodeURIComponent(value)}`)
                .then(res => res.json())
                .then(data => {
                    currentWarning.style.display = data.isValid ? 'none' : 'block';
                });

            markFormChanged();
        }, 500); // waits 500ms after typing stops
    });

    // Checklist items
    const checkLength = document.getElementById('epf-check-length');
    const checkUpper = document.getElementById('epf-check-uppercase');
    const checkNumber = document.getElementById('epf-check-number');
    const checkSymbol = document.getElementById('epf-check-symbol');

    let formChanged = false;

    function markFormChanged() {
        formChanged = true;
        submitBtn.disabled = false;
    }

    // Avatar preview
    changeAvatarBtn.addEventListener('click', () => avatarInput.click());

    // --- Avatar file validation ---
    const avatarWarning = document.createElement('div');
    avatarWarning.style.color = 'red';
    avatarWarning.style.fontSize = '0.85rem';
    avatarWarning.style.marginTop = '0.25rem';
    avatarInput.parentNode.appendChild(avatarWarning);

    avatarInput.addEventListener('change', e => {
        const file = e.target.files[0];
        const maxSizeMB = 20;

        if (!file) {
            avatarWarning.innerText = '';
            submitBtn.disabled = !formChanged;
            avatarPreview.src = "@Model.User.UserAvatar"; // reset to original avatar if needed
            return;
        }

        if (file.size > maxSizeMB * 1024 * 1024) {
            avatarWarning.innerText = `File size exceeds ${maxSizeMB} MB. Please select a smaller image.`;
            avatarPreview.src = "@Model.User.UserAvatar"; // reset preview
            e.target.value = ''; // clear file input
            submitBtn.disabled = true;
        }  else {
            avatarWarning.innerText = '';
            const reader = new FileReader();
            reader.onload = ev => avatarPreview.src = ev.target.result;
            reader.readAsDataURL(file);

            // Enable save button if the form has changes
            submitBtn.disabled = false;
            markFormChanged();
        }
    });

    // Toggle password section
    passwordToggleBtn.addEventListener('click', () => {
        passwordSection.style.display = passwordSection.style.display === 'flex' ? 'none' : 'flex';
        markFormChanged();
    });

    // Toggle password visibility
    function togglePassword(id, icon) {
        const input = document.getElementById(id);
        input.type = input.type === 'password' ? 'text' : 'password';
        icon.textContent = input.type === 'text' ? "👁️" : "👁️‍🗨️";
        markFormChanged();
    }

    // Enable save on any input change
    form.querySelectorAll('input').forEach(input => input.addEventListener('input', markFormChanged));

    // --- Validation ---
    function validateText(input, warning, pattern) {
        warning.style.display = input.value.length && !pattern.test(input.value) ? 'block' : 'none';
    }

    // Email validation
    const emailRegex = new RegExp("^[^\\s\\u0040]+\\u0040[^\\s\\u0040]+\\.[^\\s\\u0040]+$");

    emailInput.addEventListener('input', () => {
        validateText(emailInput, document.getElementById('epf-email-warning'), emailRegex);
    });

    // Name validation
    firstNameInput.addEventListener('input', () => {
        validateText(firstNameInput, document.getElementById('epf-firstname-warning'), /^[A-Za-z\s-]+$/);
    });
    lastNameInput.addEventListener('input', () => {
        validateText(lastNameInput, document.getElementById('epf-lastname-warning'), /^[A-Za-z\s-]+$/);
    });

    birthDateInput.addEventListener('input', markFormChanged);

    // Password checklist
    function validatePassword() {
        const pass = newPassword.value;
        const confirm = confirmPassword.value;

        // Show checklist only if NewPassword has input
        if (!pass) {
            passwordChecklist.style.display = 'none';
        } else {
            passwordChecklist.style.display = 'block';
        }

        checkLength.textContent = (pass.length >= 8 ? "✔️" : "❌") + " At least 8 characters";
        checkUpper.textContent = (/[A-Z]/.test(pass) ? "✔️" : "❌") + " At least one uppercase letter";
        checkNumber.textContent = (/\d/.test(pass) ? "✔️" : "❌") + " At least one number";
        checkSymbol.textContent = (/[^A-Za-z0-9]/.test(pass) ? "✔️" : "❌") + " At least one symbol";

        // Confirm password warning is still based on both fields
        confirmWarning.style.display = (confirm && pass !== confirm) ? 'block' : 'none';
    }

    // Initially hide checklist
    passwordChecklist.style.display = 'none';

    // Only listen for NewPassword and ConfirmPassword changes
    [newPassword, confirmPassword].forEach(el => el.addEventListener('input', () => {
        validatePassword();
        markFormChanged();
    }));


    // Modal
    form.addEventListener('submit', e => {
        e.preventDefault();
        modalOverlay.style.display = 'flex';
    });

    modalConfirm.addEventListener('click', () => {
        modalOverlay.style.display = 'none';

        // Disable submit button to prevent multiple clicks
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...'; // optional: indicate loading

        form.submit();
    });

    modalCancel.addEventListener('click', () => {
        modalOverlay.style.display = 'none';
    });

    const emailToggleBtn = document.getElementById('epf-toggle-email-btn');
    const emailSection = document.getElementById('epf-email-section');
    const emailModal = document.getElementById('epf-email-modal-overlay');
    const emailConfirm = document.getElementById('epf-email-confirm');
    const emailCancel = document.getElementById('epf-email-cancel');

    // Change Email flow
    emailToggleBtn.addEventListener('click', () => {
        emailModal.style.display = 'flex'; // show warning modal
    });

    // Confirm
    emailConfirm.addEventListener('click', () => {
        emailModal.style.display = 'none';
        emailSection.style.display = 'block';
        emailInput.setAttribute('required', 'required'); // make required only when shown
        emailInput.focus(); // autofocus for better UX
        markFormChanged();
    });

    emailCancel.addEventListener('click', () => {
        emailModal.style.display = 'none';
        emailInput.removeAttribute('required'); // remove required if user cancels
    });

        let emailExistsTimeout;
    emailInput.addEventListener('input', () => {
        const emailWarning = document.getElementById('epf-email-exists-warning');

        // Reset warning and enable button initially
        emailWarning.style.display = 'none';
        submitBtn.disabled = false;

        // Only check if input is not empty and matches email pattern
        if (!emailInput.value || !emailRegex.test(emailInput.value)) return;

        fetch(`/UserProfile/CheckEmailExist?email=${encodeURIComponent(emailInput.value)}`)
        .then(res => res.json())
        .then(data => {
            if (data.exists) {
                emailWarning.style.display = 'block';
                submitBtn.disabled = true; // disable Save Changes
            } else {
                emailWarning.style.display = 'none';
                submitBtn.disabled = false; // enable Save Changes
            }
        });
    });

    // --- BEFOREUNLOAD WARNING ---
    let beforeUnloadListener = function (e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = ""; // Standard for most browsers
        }
    };

    window.addEventListener('beforeunload', beforeUnloadListener);

    // Remove listener before actual form submission
    modalConfirm.addEventListener('click', () => {
        modalOverlay.style.display = 'none';

        // Disable the submit button to prevent multiple clicks
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...'; // optional: indicate loading

        // Remove beforeunload listener so it doesn't pop up
        window.removeEventListener('beforeunload', beforeUnloadListener);

        form.submit();
    });
</script>