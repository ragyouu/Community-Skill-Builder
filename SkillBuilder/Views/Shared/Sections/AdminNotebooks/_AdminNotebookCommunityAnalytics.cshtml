@model SkillBuilder.Models.ViewModels.AdminProfileViewModel
@using System.Text.Json


<style>
    .donut-chart {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient( #2563EB 0% var(--activePercent), #C7D2FE var(--activePercent) 100% );
        position: relative;
        cursor: pointer;
        transition: transform 0.3s;
    }

        .donut-chart:hover {
            transform: scale(1.05);
        }

    .donut-hole {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        height: 60%;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
        color: #111;
    }

    .donut-chart:hover .tooltip {
        opacity: 1;
    }

    .tooltip {
        position: absolute;
        background: #fff;
        border-radius: 6px;
        padding: 6px 10px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        font-size: 0.85rem;
        font-weight: 600;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
    }

    .tooltip-active {
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        color: #2563EB;
    }

    .tooltip-inactive {
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
        color: #C7D2FE;
    }
</style>

<div style="max-width:1100px; margin:0 auto; font-family:Inter, sans-serif; padding:20px;">

    <!-- Header and Date Range -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <div>
            <h2 style="font-weight:700; font-size:1.75rem; margin:0;color: #344AEA;">Community Management Analytics</h2>
            <p style="color:#555; margin-top:4px;">Monitor the health of Tahi's online communities.</p>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
            <label for="communityDateRange" style="color:#666; font-size:0.95rem;">Date:</label>
            <select id="communityDateRange" style="padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff;">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="lastweek">Last Week</option>
                <option value="lastmonth" selected>Last Month</option>
                <option value="lastyear">Last Year</option>
            </select>
        </div>
    </div>

    <!-- Alert for flagged posts -->
    @{
        var flaggedCount = Model.CommunityAnalytics?.FlaggedPostsCount ?? 0;
    }
    @if (flaggedCount > 0)
    {
        <div style="background:#FEE2E2; border:1px solid #FCA5A5; border-radius:6px; padding:12px 16px; color:#B91C1C; font-weight:600; display:flex; align-items:center; gap:8px; margin-bottom:20px;">
            <svg xmlns="http://www.w3.org/2000/svg" style="height:20px; width:20px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
            <span>
                @flaggedCount posts have been flagged and require moderation review.
                <a href="javascript:void(0);" id="reviewPostsLink"
                   style="color:#B91C1C; text-decoration:underline; font-weight:700; margin-left:8px;">
                    Review Posts →
                </a>
            </span>
        </div>
    }

    <!-- Summary cards -->
    <div style="display:flex; background:#F9FAFB; border-radius:12px; padding:24px; justify-content:space-between; box-shadow:0 2px 12px rgba(0,0,0,0.1); margin-bottom:32px;">
        <div style="text-align:center; flex:1;">
            <div style="font-weight:700; font-size:2rem; color:#111;">@Model.CommunityAnalytics?.TotalCommunities</div>
            <div style="color:#555; margin-top:4px;">Total Communities</div>
        </div>
        <div style="text-align:center; flex:1;">
            <div style="font-weight:700; font-size:2rem; color:#111;">@Model.CommunityAnalytics?.TotalPosts</div>
            <div style="color:#555; margin-top:4px;">
                Total General Posts
            </div>
        </div>
        <div style="text-align:center; flex:1;">
            <div style="font-weight:700; font-size:2rem; color:#111;">@flaggedCount</div>
            <div style="color:#555; margin-top:4px;">Flagged Posts</div>
        </div>
    </div>

    <!-- Communities with Highest Engagement and Members Distribution -->
    <div style="display:flex; gap:24px; margin-bottom:32px;">
        <!-- Communities Table -->
        <div style="flex:3; border-radius:8px; padding:20px; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,0.1);">
            <h3 style="font-weight:600; font-size:1.25rem; margin-bottom:16px;">Communities with Highest Engagement</h3>

            <table style="width:100%; border-collapse: collapse; font-size:0.9rem;">
                <thead>
                    <tr style="text-transform: uppercase; font-weight:600; color:#555; border-bottom:2px solid #E5E7EB;">
                        <th style="padding:10px 12px; text-align:left;">Community Name</th>
                        <th style="padding:10px 12px; text-align:right; width:80px;">Members</th>
                        <th style="padding:10px 12px; text-align:right; width:80px;">Posts</th>
                        <th style="padding:10px 12px; text-align:left; width:110px;">Category</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.CommunityAnalytics?.TopCommunities != null)
                    {
                        foreach (var community in Model.CommunityAnalytics.TopCommunities)
                        {
                            <tr style="border-bottom:1px solid #E5E7EB; color:#333;">
                                <td style="padding:12px 12px;">@community.Name</td>
                                <td style="padding:12px 12px; text-align:right;">@community.MembersCount</td>
                                <td style="padding:12px 12px; text-align:right;">@community.TotalPosts</td>
                                <td style="padding:12px 12px;">@community.Category</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Members Distribution Donut Chart -->
        <div style="flex:1; background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center;">
            <h3 style="font-weight:600; font-size:1.1rem; margin-bottom:16px;">Community Members Distribution</h3>

            @{
                var active = Model.CommunityAnalytics?.MembersWithPosts ?? 0;
                var inactive = Model.CommunityAnalytics?.MembersWithoutPosts ?? 0;
                var total = active + inactive;
                var activePercent = total > 0 ? (active * 100.0 / total) : 0;
                var inactivePercent = 100 - activePercent;
            }

            <div style="width:100%; max-width:250px; aspect-ratio:1/1; position:relative;">
                <div class="donut-chart" style="
            --activePercent:@activePercent%;
            --inactivePercent:@inactivePercent%;
        ">
                    <div class="donut-hole">@total</div>
                    <div class="tooltip tooltip-active">Active: @active</div>
                    <div class="tooltip tooltip-inactive">Inactive: @inactive</div>
                </div>
            </div>

            <div style="display:flex; justify-content:center; gap:40px; margin-top:16px; font-weight:700;">
                <div style="text-align:center; color:#2563EB;">
                    <div style="font-size:1.6rem;">@active</div>
                    <div style="font-weight:600; font-size:0.9rem;">Active</div>
                </div>
                <div style="text-align:center; color:#C7D2FE;">
                    <div style="font-size:1.6rem;">@inactive</div>
                    <div style="font-weight:600; font-size:0.9rem;">Inactive</div>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const analytics = @Html.Raw(JsonSerializer.Serialize(Model.CommunityAnalytics ?? new SkillBuilder.Models.Analytics.CommunityAnalyticsDto()));

            const ctx = document.getElementById('membersDonutChart').getContext('2d');

            // Destroy previous chart if it exists
            if (window.membersDonutChartInstance) {
                window.membersDonutChartInstance.destroy();
            }

            // Use requestAnimationFrame to ensure canvas has computed dimensions
            requestAnimationFrame(() => {
                window.membersDonutChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Inactive'],
                        datasets: [{
                            data: [analytics.MembersWithPosts || 0, analytics.MembersWithoutPosts || 0],
                            backgroundColor: ['#2563EB', '#C7D2FE'],
                            hoverOffset: 20,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            });

            // Click handler for Review Posts link
            document.addEventListener('click', e => {
                if (e.target && e.target.id === 'reviewPostsLink') {
                    e.preventDefault();
                    const reportTab = document.querySelector('.admin-tab[data-tab="reports"]');
                    if (reportTab) reportTab.click();
                    const mainPanel = document.querySelector('.admin-main');
                    if (mainPanel) mainPanel.scrollTop = 0;
                }
            });
        });
    </script>
}