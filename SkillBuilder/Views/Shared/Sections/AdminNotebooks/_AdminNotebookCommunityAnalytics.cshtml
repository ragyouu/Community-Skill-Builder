@model SkillBuilder.Models.ViewModels.AdminProfileViewModel
@using System.Text.Json

<div style="max-width:1100px; margin:0 auto; font-family:Inter, sans-serif; padding:20px;">

    <!-- Header and Date Range -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <div>
            <h2 style="font-weight:700; font-size:1.75rem; margin:0;color: #344AEA;">Community Management Analytics</h2>
            <p style="color:#555; margin-top:4px;">Monitor the health of Tahi's online communities.</p>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
            <label for="communityDateRange" style="color:#666; font-size:0.95rem;">Date:</label>
            <select id="communityDateRange" style="padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff;">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="lastweek">Last Week</option>
                <option value="lastmonth">Last Month</option>
                <option value="lastyear">Last Year</option>
                <option value="overall" selected>Overall</option>
            </select>
        </div>
    </div>

    <!-- Alert for flagged posts -->
    @{
        var flaggedCount = Model.CommunityAnalytics?.FlaggedPostsCount ?? 0;
    }
    @if (flaggedCount > 0)
    {
        <div style="background:#FEE2E2; border:1px solid #FCA5A5; border-radius:6px; padding:12px 16px; color:#B91C1C; font-weight:600; display:flex; align-items:center; gap:8px; margin-bottom:20px;">
            <svg xmlns="http://www.w3.org/2000/svg" style="height:20px; width:20px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
            <span>
                @flaggedCount posts have been flagged and require moderation review.
                <a href="javascript:void(0);" id="reviewPostsLink"
                   style="color:#B91C1C; text-decoration:underline; font-weight:700; margin-left:8px;">
                    Review Posts →
                </a>
            </span>
        </div>
    }

    <!-- Community Summary Cards -->
    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin-top:20px;">

        <div class="card" style="background:#fff; padding:20px; border-radius:12px;
         box-shadow:0 2px 12px rgba(0,0,0,0.1); text-align:center;">
            <div id="totalCommunities" style="font-size:1.75rem; font-weight:700; color:#111;">
                @Model.CommunityAnalytics?.TotalCommunities
            </div>
            <div style="color:#666;">Total Communities</div>
        </div>

        <div class="card" style="background:#fff; padding:20px; border-radius:12px;
         box-shadow:0 2px 12px rgba(0,0,0,0.1); text-align:center;">
            <div id="totalPosts" style="font-size:1.75rem; font-weight:700; color:#111;">
                @Model.CommunityAnalytics?.TotalPosts
            </div>
            <div style="color:#666;">Total General Posts</div>
        </div>

        <div class="card" style="background:#fff; padding:20px; border-radius:12px;
         box-shadow:0 2px 12px rgba(0,0,0,0.1); text-align:center;">
            <div id="flaggedPosts" style="font-size:1.75rem; font-weight:700; color:#111;">
                @flaggedCount
            </div>
            <div style="color:#666;">Flagged Posts</div>
        </div>

    </div>

    <!-- Communities with Highest Engagement and Members Distribution -->
    <div style="display:flex; gap:24px; margin-bottom:32px; margin-top: 25px;">
        <!-- Communities Table -->
        <div style="flex:3; border-radius:8px; padding:20px; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,0.1); max-width: 600px;">
            <h3 style="font-weight:600; font-size:1.25rem; margin-bottom:16px;">Communities with Highest Engagement</h3>

            <table style="width:100%; border-collapse: collapse; font-size:0.9rem;">
                <thead>
                    <tr style="text-transform: uppercase; font-weight:600; color:#555; border-bottom:2px solid #E5E7EB;">
                        <th style="padding:10px 12px; text-align:left;">Community Name</th>
                        <th style="padding:10px 12px; text-align:right; width:80px;">Members</th>
                        <th style="padding:10px 12px; text-align:right; width:80px;">Posts</th>
                        <th style="padding:10px 12px; text-align:left; width:110px;">Category</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.CommunityAnalytics?.TopCommunities != null)
                    {
                        foreach (var community in Model.CommunityAnalytics.TopCommunities)
                        {
                            <tr style="border-bottom:1px solid #E5E7EB; color:#333;">
                                <td style="padding:12px 12px;">@community.Name</td>
                                <td style="padding:12px 12px; text-align:right;">@community.MembersCount</td>
                                <td style="padding:12px 12px; text-align:right;">@community.TotalPosts</td>
                                <td style="padding:12px 12px;">@community.Category</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Members Distribution Donut Chart -->
        <div style="flex:1; background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center;">
            <h3 style="font-weight:600; font-size:1.1rem; margin-bottom:16px;">Community Members Distribution</h3>

            <div style="width:100%; max-width:250px; aspect-ratio:1/1; position:relative;">
                <canvas id="membersDonutChart"></canvas>
                <div id="donutCenter" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-weight:700; font-size:1.2rem; color:#111;">
                    0
                </div>
            </div>

            <div style="display:flex; justify-content:center; gap:40px; margin-top:16px; font-weight:700;">
                <div id="activeLabel" style="text-align:center; color:#2563EB;">
                    <div style="font-size:1.6rem;">0</div>
                    <div style="font-weight:600; font-size:0.9rem;">Active</div>
                </div>
                <div id="inactiveLabel" style="text-align:center; color:#C7D2FE;">
                    <div style="font-size:1.6rem;">0</div>
                    <div style="font-weight:600; font-size:0.9rem;">Inactive</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dateSelect = document.getElementById('communityDateRange');

        // Date range change logic (unchanged)
        dateSelect.addEventListener('change', async () => {
            const range = dateSelect.value;

            try {
                const res = await fetch(`/AdminProfile/GetCommunitySummaryByRange?range=${range}`);
                if (!res.ok) throw new Error('Failed to fetch');

                const data = await res.json();

                // Update the summary cards
                document.getElementById('totalCommunities').textContent = data.totalCommunities;
                document.getElementById('totalPosts').textContent = data.totalPosts;
                document.getElementById('flaggedPosts').textContent = data.flaggedPosts;

            } catch (err) {
                console.error('Error updating summary cards:', err);
            }
        });

        // Initial analytics data
        const analytics = @Html.Raw(JsonSerializer.Serialize(Model.CommunityAnalytics ?? new SkillBuilder.Models.Analytics.CommunityAnalyticsDto()));
        const initialActive = analytics.MembersWithPosts || 0;
        const initialInactive = analytics.MembersWithoutPosts || 0;

        // Update center and labels function
        function updateDonutChart(active, inactive) {
            const total = active + inactive;

            // Animate center number
            const centerEl = document.getElementById('donutCenter');
            const start = parseInt(centerEl.textContent, 10) || 0;
            const duration = 800; // animation duration in ms
            const startTime = performance.now();

            function animateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const value = Math.floor(start + (total - start) * progress);
                centerEl.textContent = value;
                if (progress < 1) requestAnimationFrame(animateNumber);
            }

            requestAnimationFrame(animateNumber);

            // Update Active/Inactive labels instantly
            document.querySelector('#activeLabel div:first-child').textContent = active;
            document.querySelector('#inactiveLabel div:first-child').textContent = inactive;

            // Update Chart.js data
            if (window.membersDonutChartInstance) {
                window.membersDonutChartInstance.data.datasets[0].data = [active, inactive];
                window.membersDonutChartInstance.update();
            }
        }

        // Initialize Chart.js donut
        const ctx = document.getElementById('membersDonutChart').getContext('2d');

        if (window.membersDonutChartInstance) {
            window.membersDonutChartInstance.destroy();
        }

        window.membersDonutChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Inactive'],
                datasets: [{
                    data: [initialActive, initialInactive],
                    backgroundColor: ['#2563EB', '#C7D2FE'],
                    hoverOffset: 20,
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });

        // Set initial center and labels
        updateDonutChart(initialActive, initialInactive);

        // Click handler for Review Posts link (unchanged)
        document.addEventListener('click', e => {
            if (e.target && e.target.id === 'reviewPostsLink') {
                e.preventDefault();
                const reportTab = document.querySelector('.admin-tab[data-tab="reports"]');
                if (reportTab) reportTab.click();
                const mainPanel = document.querySelector('.admin-main');
                if (mainPanel) mainPanel.scrollTop = 0;
            }
        });
    });
</script>