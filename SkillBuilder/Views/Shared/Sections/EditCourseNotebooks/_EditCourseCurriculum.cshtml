@model SkillBuilder.Models.ViewModels.CourseBuilderViewModel
@using System.Text.Json

<style>
    /* === Mirror CSS from _CreateCourseCurriculum === */
    .curriculum-edit-container {
        margin-bottom: 2rem;
    }

    .curriculum-edit-module {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .curriculum-edit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .curriculum-edit-form-group {
        margin-bottom: 1rem;
        margin-top: 1rem;
    }

        .curriculum-edit-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

    .curriculum-edit-form-control, .curriculum-edit-form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
    }

    .curriculum-edit-form-row {
        display: flex;
        gap: 2rem;
    }

    .curriculum-edit-form-col {
        flex: 1;
    }

    .curriculum-edit-delete-btn {
        background: none;
        border: none;
        color: #888;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .curriculum-edit-lesson-block {
        border-top: 1px dashed #ccc;
        padding-top: 1rem;
        margin-top: 1rem;
        position: relative;
    }

    .curriculum-edit-add-btn {
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        font-weight: 600;
        color: #344AEA;
        background-color: transparent;
        border: 1.5px solid #344AEA;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
        margin-bottom: 1rem;
    }

        .curriculum-edit-add-btn:hover {
            background-color: #344AEA;
            color: white;
        }

    .curriculum-edit-lesson-duration-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .curriculum-edit-lesson-duration-value {
        width: 150px !important;
    }

    .curriculum-edit-lesson-duration-unit {
        flex: 1;
    }

    .curriculum-edit-lesson-delete-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #888;
        cursor: pointer;
    }

    .curriculum-edit-quiz-question {
        border-top: 1px dashed #ccc;
        padding-top: 0.5rem;
        margin-top: 0.5rem;
        position: relative;
    }

    .curriculum-edit-quiz-delete-btn {
        position: absolute;
        top: 0.2rem;
        right: 0.2rem;
        background: none;
        border: none;
        color: #888;
        font-size: 1rem;
        cursor: pointer;
    }

    .curriculum-edit-lesson-preview img,
    .curriculum-edit-lesson-preview video {
        max-width: 100%;
        height: auto;
        display: block;
        margin-bottom: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    .curriculum-edit-form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
    }

    /* Module Tabs – Edit View */
    .edit-module-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #ddd;
        padding-bottom: 0.5rem;
    }

    .edit-module-tab {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        background: #f3f3f3;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
    }

        .edit-module-tab.active {
            background: #007bff;
            color: white;
        }

        .edit-module-tab:hover {
            background: #e6e6e6;
        }

        .edit-module-tab.no-delete {
            cursor: default;
        }

    .lesson-interactive-block {
        position: relative; /* required for absolute positioning of delete button */
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
        background: #fafafa;
    }

        .lesson-interactive-block .curriculum-edit-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
        }
</style>

<div class="curriculum-edit-container">

    <!-- Top bar: warning + Add Module button -->
    <div class="curriculum-edit-add-module-wrapper" style="margin-bottom: 1rem; display:flex; justify-content: space-between; align-items:center;">
        <div id="curriculum-edit-module-warning" style="color:red; display:none;">
            You must add at least 2 modules.
        </div>
        <button type="button" class="curriculum-edit-add-btn" onclick="curriculumEditAddModule()">+ Add Module</button>
    </div>

    <!-- Module Tabs -->
    <div id="curriculum-edit-module-tabs" class="edit-module-tabs" style="margin-bottom: 1rem;"></div>

    <!-- Modules Container -->
    <div class="curriculum-edit-modules" id="curriculum-edit-modules-container"></div>

    <!-- Final Project Module -->
    <div class="curriculum-edit-final-project curriculum-edit-module" id="curriculum-edit-final-project-module" data-index="final-project" style="display:none;">
        <div class="curriculum-edit-header"><strong>Final Project</strong></div>

        <div class="curriculum-edit-form-group">
            <label>Title *</label>
            <input type="text" class="curriculum-edit-form-control" name="FinalProject.Title" placeholder="Final project title" required />
        </div>

        <div class="curriculum-edit-form-group">
            <label>Details / Context *</label>
            <textarea style="height: 350px;" class="curriculum-edit-form-control" name="FinalProject.Description" rows="4" placeholder="Describe the final project..." required></textarea>
        </div>
    </div>
</div>
<!-- Global Delete Confirmation Modal -->
<div id="global-delete-modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
    <div style="background:white; padding:2rem; border-radius:8px; max-width:400px; width:90%; text-align:center;">
        <p id="global-delete-message" style="margin-bottom:1.5rem; font-size:1.1rem;">Are you sure?</p>
        <div style="display:flex; justify-content:center; gap:1rem;">
            <button type="button" id="global-delete-confirm"
                    style="padding:0.5rem 1rem; background:#e53935; color:white; border:none; border-radius:6px; cursor:pointer;">
                Delete
            </button>
            <button type="button" id="global-delete-cancel"
                    style="padding:0.5rem 1rem; background:#ccc; color:black; border:none; border-radius:6px; cursor:pointer;">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>

    function initTinyMCE(target = '.tinymce-editor', allowImages = true) {
        if (typeof tinymce === 'undefined') return;

        const plugins = allowImages ? 'lists link image table code autoresize' : 'lists link table code autoresize';
        const toolbar = allowImages
            ? 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist | image'
            : 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist';

        const config = {
            height: 250,
            menubar: false,
            plugins,
            toolbar,
            automatic_uploads: allowImages,
            convert_urls: false,
            relative_urls: false,
            branding: false,
            license_key: 'gpl',
            setup: (editor) => {
                editor.on('change', () => editor.save());
                editor.on('init', () => setTimeout(() => editor.execCommand('mceAutoResize'), 50));
            }
        };

        // Special handling for interactive content
        if (allowImages) {
            config.images_upload_url = '/ArtisanActions/UploadInteractiveImage';
            config.images_reuse_filename = false;
            config.file_picker_types = 'image';
            config.file_picker_callback = function(callback, value, meta) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function() {
                    const file = this.files[0];
                    if (!file) return;

                    const maxSizeMB = 20;
                    if (file.size > maxSizeMB * 1024 * 1024) {
                        alert(`File too large! Maximum allowed size is ${maxSizeMB}MB.`);
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', file);

                    fetch('/ArtisanActions/UploadInteractiveImage', {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.location) callback(data.location);
                        else alert('Upload failed.');
                    })
                    .catch(() => alert('Upload error.'));
                };
                input.click();
            };
        }

        if (target instanceof HTMLElement) {
            const id = target.id || `tinymce-${crypto.randomUUID()}`;
            target.id = id;

            // ✅ ALWAYS REMOVE EXISTING INSTANCE BEFORE REINITIALIZING
            if (tinymce.get(id)) {
                tinymce.get(id).remove();
            }

            config.target = target;
            tinymce.init(config);
        } else {
            // ✅ REMOVE ALL MATCHING SELECTORS
            tinymce.remove(target);
            config.selector = target;
            tinymce.init(config);
        }
    }

    let allModulesData = []; // store all modules
    let activeModuleIndex = 0; // currently active module/tab

    function renderModuleTabs() {
        const tabsContainer = document.getElementById("curriculum-edit-module-tabs");
        tabsContainer.innerHTML = '';

        allModulesData.forEach((mod, index) => {
            const tab = document.createElement("button");
            tab.type = "button";
            tab.className = 'curriculum-edit-add-btn';
            tab.textContent = `Module ${index + 1}`;

            if(index === activeModuleIndex){
                tab.style.backgroundColor = '#344AEA';
                tab.style.color = 'white';
            }

            tab.addEventListener('click', () => {
                activeModuleIndex = index;
                renderModuleTabs();      // update tab styling
                renderModuleLessons(index); // show correct module
            });

            tabsContainer.appendChild(tab);
        });

        // Final Project Tab
        const fpTab = document.createElement("button");
        fpTab.type = "button";
        fpTab.className = 'curriculum-edit-add-btn';
        fpTab.textContent = 'Final Project';
        if(activeModuleIndex === 'fp'){
            fpTab.style.backgroundColor = '#344AEA';
            fpTab.style.color = 'white';
        }
        fpTab.addEventListener('click', () => {
            activeModuleIndex = 'fp';
            renderModuleTabs();
            renderFinalProject();
        });
        tabsContainer.appendChild(fpTab);
    }

    function renderModuleLessons(moduleIndex) {
        const fpDiv = document.getElementById("curriculum-edit-final-project-module");
        if(fpDiv) fpDiv.style.display = 'none'; // hide final project

        const container = document.getElementById("curriculum-edit-modules-container");

        // Show/hide modules based on activeModuleIndex
        container.querySelectorAll(".curriculum-edit-module").forEach((mod, idx) => {
            mod.style.display = (idx === moduleIndex) ? "block" : "none";
        });

        // If module doesn't exist yet, create it
        if(!container.querySelector(`.curriculum-edit-module[data-index='${moduleIndex}']`)) {
            const moduleData = allModulesData[moduleIndex];
            const moduleDiv = document.createElement("div");
            moduleDiv.className = "curriculum-edit-module";
            moduleDiv.setAttribute("data-index", moduleIndex);

            moduleDiv.innerHTML = `
                <div class="curriculum-edit-header">
                    <strong class="curriculum-edit-module-label">Module ${moduleIndex+1}</strong>
                    <button type="button" class="curriculum-edit-delete-btn"
                        onclick="showDeleteModal('module', () => curriculumEditRemoveModule(${moduleIndex}))">🗑️</button>
                </div>
                <div class="curriculum-edit-form-group">
                    <label>Module Title *</label>
                    <input type="text" class="curriculum-edit-form-control"
                           name="Modules[${moduleIndex}].Title"
                           value="${moduleData?.Title || ''}" required />
                </div>
                <div class="curriculum-edit-lessons" id="curriculum-edit-lessons-${moduleIndex}"></div>
                <button type="button" class="curriculum-edit-add-btn" style="margin-top: 3rem;" onclick="curriculumEditAddLesson(${moduleIndex})">+ Add Lesson</button>
            `;

            container.appendChild(moduleDiv);

            if(moduleData?.Lessons?.length){
                moduleData.Lessons.forEach(lesson => curriculumEditAddLesson(moduleIndex, lesson));
            }
        }
    }

    function renderFinalProject() {
        const fpDiv = document.getElementById("curriculum-edit-final-project-module");
        if (!fpDiv) return;

        const container = document.getElementById("curriculum-edit-modules-container");

        // Hide all modules
        container.querySelectorAll(".curriculum-edit-module").forEach(mod => mod.style.display = "none");

        // Show final project
        fpDiv.style.display = 'block';
    }

    let deleteCallback = null;

    function showDeleteModal(type, callback) {
        deleteCallback = callback; // store callback to run on confirm
        const modal = document.getElementById('global-delete-modal');
        const message = document.getElementById('global-delete-message');
        message.textContent = `Are you sure you want to delete this ${type}? This action cannot be undone.`;
        modal.style.display = 'flex';
    }

    document.getElementById('global-delete-confirm').addEventListener('click', () => {
        if (deleteCallback) deleteCallback();
        closeDeleteModal();
    });

    document.getElementById('global-delete-cancel').addEventListener('click', closeDeleteModal);

    function closeDeleteModal() {
        document.getElementById('global-delete-modal').style.display = 'none';
        deleteCallback = null;
    }

    let curriculumEditModuleIndex = 0;

    // ------------------ MODULE FUNCTIONS ------------------
    function curriculumEditAddModule(moduleData = null) {
        const container = document.getElementById("curriculum-edit-modules-container"); // ✅ correct ID
        if (!container) return; // safety check

        const moduleIndex = curriculumEditModuleIndex++;

        allModulesData.push(moduleData || { Title: '', Lessons: [] });

        const moduleDiv = document.createElement("div");
        moduleDiv.className = "curriculum-edit-module";
        moduleDiv.setAttribute("data-index", moduleIndex);

        moduleDiv.innerHTML = `
            <div class="curriculum-edit-header">
                <strong class="curriculum-edit-module-label">Module ${moduleIndex + 1}</strong>
                <button type="button" class="curriculum-edit-delete-btn" onclick="showDeleteModal('module', () => curriculumEditRemoveModule(${moduleIndex}))">🗑️</button>
            </div>
            <div class="curriculum-edit-form-group">
                <label>Module Title *</label>
                <input type="text" class="curriculum-edit-form-control" name="Modules[${moduleIndex}].Title" placeholder="Module title" value="${moduleData?.Title || ''}" required />
            </div>
            <div class="curriculum-edit-lessons" id="curriculum-edit-lessons-${moduleIndex}"></div>
            <button type="button" class="curriculum-edit-add-btn" style="margin-top: 3rem;" onclick="curriculumEditAddLesson(${moduleIndex})">+ Add Lesson</button>
        `;
        container.appendChild(moduleDiv);

        if(moduleData?.Lessons?.length){
            moduleData.Lessons.forEach(lesson => curriculumEditAddLesson(moduleIndex, lesson));
        } else {
            // Only add 1 default lesson for new module
            curriculumEditAddLesson(moduleIndex);
        }

        curriculumEditRenumberModules();
        activeModuleIndex = moduleIndex;
        renderModuleTabs();
        renderModuleLessons(moduleIndex);

        // Update delete buttons visibility
        updateLessonDeleteButtons(moduleIndex);
    }

    function curriculumEditRemoveModule(index) {
        const modules = document.querySelectorAll(".curriculum-edit-module:not(#curriculum-edit-final-project-module)");
        if(modules.length <= 2){
            const warning = document.getElementById("curriculum-edit-module-warning");
            if(warning) warning.style.display = 'block';
            return;
        }

        const module = document.querySelector(`.curriculum-edit-module[data-index='${index}']`);
        if(module) module.remove();

        // Remove corresponding data from allModulesData
        allModulesData.splice(index, 1);

        // --- FIX: Adjust activeModuleIndex ---
        if(activeModuleIndex === index) {
            // Deleted module was active, show previous module if exists, else first module
            activeModuleIndex = index > 0 ? index - 1 : 0;
        } else if (activeModuleIndex > index) {
            // Shift active index if it was after the deleted module
            activeModuleIndex--;
        }

        curriculumEditRenumberModules();

        const warning = document.getElementById("curriculum-edit-module-warning");
        if(warning) warning.style.display = allModulesData.length < 2 ? "block" : "none";

        // Re-render tabs and the currently active module
        renderModuleTabs();
        renderModuleLessons(activeModuleIndex);
    }

    function updateLessonDeleteButtons(moduleIndex) {
        const lessonsContainer = document.getElementById(`curriculum-edit-lessons-${moduleIndex}`);
        if(!lessonsContainer) return;

        const lessons = lessonsContainer.children;
        const showDelete = lessons.length > 1; // Show delete buttons only if more than 1 lesson

        Array.from(lessons).forEach((lesson) => {
            const deleteBtn = lesson.querySelector(".curriculum-edit-lesson-delete-btn");
            if(deleteBtn){
                deleteBtn.style.display = showDelete ? 'block' : 'none';
            }
        });
    }


    // ------------------ LESSON FUNCTIONS ------------------
    function curriculumEditAddLesson(moduleIndex, lessonData = null) {
        const lessonsContainer = document.getElementById(`curriculum-edit-lessons-${moduleIndex}`);
        if(!lessonsContainer) return;
        const lessonIndex = lessonsContainer.children.length;

        const lessonDiv = document.createElement("div");
        lessonDiv.className = "curriculum-edit-lesson-block";

        lessonDiv.innerHTML = `
            <div class="curriculum-edit-lesson-header">
                <button type="button" class="curriculum-edit-lesson-delete-btn">🗑️</button>
            </div>

            <input type="hidden" name="Modules[${moduleIndex}].Lessons[${lessonIndex}].Id" value="${lessonData?.Id || 0}" />

            <div class="curriculum-edit-form-row">
                <div class="curriculum-edit-form-col curriculum-edit-form-group">
                    <label>Lesson Title *</label>
                    <input type="text" class="curriculum-edit-form-control"
                           name="Modules[${moduleIndex}].Lessons[${lessonIndex}].Title"
                           placeholder="Lesson title"
                           value="${lessonData?.Title || ''}" required />
                </div>
                <div class="curriculum-edit-form-col curriculum-edit-form-group">
                    <label>Lesson Type *</label>
                    <select class="curriculum-edit-form-select"
                            name="Modules[${moduleIndex}].Lessons[${lessonIndex}].LessonType"
                            onchange="curriculumEditHandleLessonTypeChange(this, ${moduleIndex}, ${lessonIndex})"
                            required>
                        <option value="">-- Select Type --</option>
                        <option value="Text" ${lessonData?.LessonType==='Text'?'selected':''}>Text</option>
                        <option value="Image + Text" ${lessonData?.LessonType==='Image + Text'?'selected':''}>Image + Text</option>
                        <option value="Video + Text" ${lessonData?.LessonType==='Video + Text'?'selected':''}>Video + Text</option>
                        <option value="Quiz" ${lessonData?.LessonType==='Quiz'?'selected':''}>Assessment</option>
                        <option value="Session" ${lessonData?.LessonType==='Session'?'selected':''}
                            ${sessionAlreadyExists(moduleIndex, lessonIndex) ? 'disabled' : ''}>Session</option>
                    </select>
                </div>
            </div>

            <div class="curriculum-edit-lesson-duration-row">
                <input type="number" class="curriculum-edit-form-control curriculum-edit-lesson-duration-value"
                       name="Modules[${moduleIndex}].Lessons[${lessonIndex}].DurationValue"
                       value="${lessonData?.DurationValue || ''}" required />
                <select class="curriculum-edit-form-select curriculum-edit-lesson-duration-unit"
                        name="Modules[${moduleIndex}].Lessons[${lessonIndex}].DurationUnit" required>
                    <option value="minutes" ${lessonData?.DurationUnit==='minutes'?'selected':''}>Minutes</option>
                    <option value="hours" ${lessonData?.DurationUnit==='hours'?'selected':''}>Hours</option>
                </select>
            </div>

            <div class="curriculum-edit-lesson-config-container"></div>
        `;

        lessonsContainer.appendChild(lessonDiv);

        const textarea = lessonDiv.querySelector("textarea.tinymce-editor");
        if(textarea){
            initTinyMCE(textarea);
        }

        const deleteBtn = lessonDiv.querySelector(".curriculum-edit-lesson-delete-btn");
        deleteBtn.addEventListener("click", () => {
            showDeleteModal("lesson", () => curriculumEditRemoveLesson(moduleIndex, deleteBtn));
        });

        if(lessonData){
            curriculumEditHandleLessonTypeChange(lessonDiv.querySelector("select"), moduleIndex, lessonIndex, lessonData);
        }

        curriculumEditRenumberLessons(moduleIndex);
        updateLessonDeleteButtons(moduleIndex);
    }

    function sessionAlreadyExists(currentModuleIndex, currentLessonIndex){
        const lessons = document.querySelectorAll(".curriculum-edit-module .curriculum-edit-lesson-block");
        for(let lesson of lessons){
            const select = lesson.querySelector("select[name$='.LessonType']");
            const moduleIndex = parseInt(lesson.closest(".curriculum-edit-module").getAttribute("data-index"));
            const lessonIndex = Array.from(lesson.parentNode.children).indexOf(lesson);
            if(select.value === "Session" && !(moduleIndex===currentModuleIndex && lessonIndex===currentLessonIndex)){
                return true;
            }
        }
        return false;
    }

    function curriculumEditRemoveLesson(moduleIndex, btn) {
        if (!btn) return; // Safety check
        const lessonsContainer = document.getElementById(`curriculum-edit-lessons-${moduleIndex}`);
        const lessonDiv = btn.closest(".curriculum-edit-lesson-block");
        if (lessonDiv) lessonDiv.remove();
        curriculumEditRenumberLessons(moduleIndex);
        updateLessonDeleteButtons(moduleIndex);
    }

    // ------------------ RENUMBERING ------------------
    function curriculumEditRenumberModules() {
        const modules = document.querySelectorAll(".curriculum-edit-module:not(#curriculum-edit-final-project-module)");
        modules.forEach((mod, i) => {
            mod.setAttribute("data-index", i);
            const label = mod.querySelector(".curriculum-edit-module-label");
            if(label) label.textContent = `Module ${i+1}`;
            const titleInput = mod.querySelector("input[name$='.Title']");
            if(titleInput) titleInput.name = `Modules[${i}].Title`;

            curriculumEditRenumberLessons(i);
            const addLessonBtn = mod.querySelector("button[onclick^='curriculumEditAddLesson']");
            if(addLessonBtn) addLessonBtn.setAttribute("onclick", `curriculumEditAddLesson(${i})`);
            const removeBtn = mod.querySelector("button[onclick^='curriculumEditRemoveModule']");
            if(removeBtn) removeBtn.setAttribute("onclick", `curriculumEditRemoveModule(${i})`);
        });
        curriculumEditModuleIndex = modules.length;
    }

    function curriculumEditRenumberLessons(moduleIndex) {
        const lessonsContainer = document.getElementById(`curriculum-edit-lessons-${moduleIndex}`);
        if (!lessonsContainer) return;

        const lessons = lessonsContainer.children;
        Array.from(lessons).forEach((lesson, i) => {
            const titleInput = lesson.querySelector("input[name$='.Title']");
            if(titleInput) titleInput.name = `Modules[${moduleIndex}].Lessons[${i}].Title`;

            const typeSelect = lesson.querySelector("select[name$='.LessonType']");
            if(typeSelect) typeSelect.name = `Modules[${moduleIndex}].Lessons[${i}].LessonType`;

            const durationVal = lesson.querySelector("input[name$='.DurationValue']");
            if(durationVal) durationVal.name = `Modules[${moduleIndex}].Lessons[${i}].DurationValue`;

            const durationUnit = lesson.querySelector("select[name$='.DurationUnit']");
            if(durationUnit) durationUnit.name = `Modules[${moduleIndex}].Lessons[${i}].DurationUnit`;

            const quizBuilder = lesson.querySelector(".curriculum-edit-quiz-builder");
            if(quizBuilder) curriculumEditRenumberQuizQuestions(quizBuilder);
        });
    }

    // ------------------ LESSON INTERACTIVE CONTENTS ------------------
    function addLessonInteractiveContent(moduleIndex, lessonIndex, data = null){
        const lessonBlock = document.querySelector(`.curriculum-edit-module[data-index='${moduleIndex}']`)
                            .querySelector(`.curriculum-edit-lesson-block:nth-child(${lessonIndex+1})`);

        let container = lessonBlock.querySelector(".interactive-contents-container");

        // create container if missing
        if(!container){
            const wrapper = document.createElement("div");
            wrapper.className = "lesson-interactive-contents";
            wrapper.innerHTML = `
                <h4>Interactive Contents</h4>
                <div class="interactive-contents-container"></div>
                <button type="button" class="curriculum-edit-add-btn" onclick="addLessonInteractiveContent(${moduleIndex}, ${lessonIndex})">+ Add Interactive Content</button>
            `;
            lessonBlock.querySelector(".curriculum-edit-lesson-config-container").appendChild(wrapper);
            container = wrapper.querySelector(".interactive-contents-container");
        }

        const index = container.children.length;
        const div = document.createElement("div");
        div.className = "lesson-interactive-block";

        div.innerHTML = `
            <div class="curriculum-edit-form-group">
                <label>Type *</label>
                <select class="curriculum-edit-form-select"
                        name="Modules[${moduleIndex}].Lessons[${lessonIndex}].InteractiveContents[${index}].ContentType"
                        onchange="handleLessonInteractiveTypeChange(this, ${moduleIndex}, ${lessonIndex}, ${index})" required>
                    <option value="">-- Select Type --</option>
                    <option value="Text" ${data?.ContentType==='Text'?'selected':''}>Text/Image</option>
                    <option value="Link" ${data?.ContentType==='Link'?'selected':''}>Link</option>
                    <option value="Reflection" ${data?.ContentType==='Reflection'?'selected':''}>Reflection</option>
                    <option value="Question" ${data?.ContentType==='Question'?'selected':''}>Question</option>
                </select>
            </div>
            <div class="interactive-extra-fields"></div>
            <div class="interactive-delete-wrapper">
                <button type="button" class="curriculum-edit-delete-btn" onclick="showDeleteModal('interactive content', () => this.closest('.lesson-interactive-block').remove())">🗑️</button>
            </div>
        `;

        container.appendChild(div);

        if(data){
            const selectEl = div.querySelector("select");
            handleLessonInteractiveTypeChange(selectEl, moduleIndex, lessonIndex, index, data);
        }

        // ------------------ INIT TINYMCE IF TYPE IS TEXT ------------------
        const textarea = div.querySelector("textarea.tinymce-editor");
        if(textarea){
            initTinyMCE(textarea);
        }
    }

    function handleLessonInteractiveTypeChange(selectEl, moduleIndex, lessonIndex, index, data = null){
        const container = selectEl.closest(".lesson-interactive-block").querySelector(".interactive-extra-fields");
        container.innerHTML = '';

        switch(selectEl.value){
            case 'Text':
                container.innerHTML = `<div class="curriculum-edit-form-group">
                    <label>Content *</label>
                    <textarea class="curriculum-edit-form-control tinymce-editor"
                              name="Modules[${moduleIndex}].Lessons[${lessonIndex}].InteractiveContents[${index}].ContentText"
                              rows="4" required>${data?.ContentText || ''}</textarea>
                </div>`;

                setTimeout(() => {
                    const textarea = container.querySelector("textarea.tinymce-editor");
                    if(textarea){
                        initTinyMCE(textarea, true); // ✅ Enable image plugin for interactive content
                    }
                }, 0);
                break;
            case 'Link':
                container.innerHTML = `<div class="curriculum-edit-form-group">
                    <label>Link *</label>
                    <input type="url" class="curriculum-edit-form-control"
                           placeholder="https://example.com"
                           name="Modules[${moduleIndex}].Lessons[${lessonIndex}].InteractiveContents[${index}].ContentText"
                           value="${data?.ContentText || ''}" required />
                </div>`;
                break;
            case 'Reflection':
                container.innerHTML = `<div class="curriculum-edit-form-group">
                    <label>Minimum Characters *</label>
                    <input type="number" class="curriculum-edit-form-control"
                           name="Modules[${moduleIndex}].Lessons[${lessonIndex}].InteractiveContents[${index}].ReflectionMinChars"
                           value="${data?.ReflectionMinChars || 0}" min="0" required />
                </div>`;
                break;
            case 'Question':
                const existing = data || {};
                container.innerHTML = `<div class="curriculum-edit-form-group">
                    <label>Question *</label>
                    <input type="text" class="curriculum-edit-form-control"
                            name="Modules[${moduleIndex}].Lessons[${lessonIndex}].InteractiveContents[${index}].ContentText"
                            value="${existing.ContentText || ''}" required />
                </div>
                <div class="curriculum-edit-form-group">
                    <label>Options *</label>
                    <div class="curriculum-edit-form-row">
                        ${['A','B','C','D'].map((letter, i) => {
                            const val = existing[`Option${letter}`] || '';
                            return `<div style="flex:1;">
                                <input type="text" class="curriculum-edit-form-control option-input"
                                        name="Modules[${moduleIndex}].Lessons[${lessonIndex}].InteractiveContents[${index}].Option${letter}"
                                        placeholder="Option ${letter}" value="${val}" required />
                                <input type="radio"
                                        name="Modules[${moduleIndex}].Lessons[${lessonIndex}].InteractiveContents[${index}].CorrectAnswer"
                                        data-letter="${letter}"
                                        value="${val || letter}" ${existing.CorrectAnswer === val || (!existing.CorrectAnswer && i===0) ? 'checked' : ''} required /> Correct
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;

                // Sync each radio's value with its corresponding option input
                ['A','B','C','D'].forEach(letter => {
                    const optInput = container.querySelector(`input[name$='Option${letter}']`);
                    const radio = container.querySelector(`input[type='radio'][name$='CorrectAnswer'][data-letter='${letter}']`);
                    if(optInput && radio){
                        // Ensure radio always has a value
                        radio.value = optInput.value || letter;

                        // If no existing CorrectAnswer, check first option
                        if(!existing.CorrectAnswer && letter === 'A') radio.checked = true;

                        // Sync radio value when user types in option input
                        optInput.addEventListener('input', e => {
                            radio.value = e.target.value || letter;
                        });
                    }
                });
                break;
        }
    }

    // ------------------ LESSON TYPE HANDLER ------------------
    function curriculumEditHandleLessonTypeChange(selectEl, moduleIndex, lessonIndex, lessonData = null) {
        const lessonBlock = selectEl.closest(".curriculum-edit-lesson-block");
        const configContainer = lessonBlock.querySelector(".curriculum-edit-lesson-config-container");
        const nameBase = `Modules[${moduleIndex}].Lessons[${lessonIndex}]`;
        let html = '';

        switch(selectEl.value){
            case 'Text':
                // Only ContentText textarea, no image upload
                html = `<div class="curriculum-edit-form-group">
                            <label>Content</label>
                            <textarea class="curriculum-edit-form-control tinymce-editor"
                                      name="${nameBase}.ContentText"
                                      rows="4" required>${lessonData?.ContentText || ''}</textarea>
                        </div>`;

                // Interactive contents container (can have image uploads)
                html += `<div class="lesson-interactive-contents">
                            <h4>Interactive Contents</h4>
                            <div class="interactive-contents-container"></div>
                            <button type="button" class="curriculum-edit-add-btn" onclick="addLessonInteractiveContent(${moduleIndex}, ${lessonIndex})">+ Add Interactive Content</button>
                        </div>`;

                configContainer.innerHTML = html;

                // Preload existing interactive contents
                if(lessonData?.InteractiveContents?.length){
                    lessonData.InteractiveContents.forEach(ic => {
                        addLessonInteractiveContent(moduleIndex, lessonIndex, ic);
                    });
                }

                // Initialize TinyMCE for lesson content only (no image upload)
                const textareaText = configContainer.querySelector("textarea.tinymce-editor");
                if(textareaText){
                    initTinyMCE(textareaText, false); // ✅ disable image plugin for Text lesson ContentText
                }

                // ✅ Reinitialize TinyMCE for all interactive content textareas
                setTimeout(() => {
                    const interactiveTextareas = configContainer.querySelectorAll(".interactive-contents-container textarea.tinymce-editor");
                    interactiveTextareas.forEach(ta => {
                        initTinyMCE(ta, true); // ✅ Enable image upload for interactive content
                    });
                }, 100);
                break;

            case 'Image + Text':
                // ContentText textarea + Image Upload for Image + Text type
                html = `<div class="curriculum-edit-form-group">
                            <label>Content</label>
                            <textarea class="curriculum-edit-form-control tinymce-editor"
                                      name="${nameBase}.ContentText"
                                      rows="4" required>${lessonData?.ContentText || ''}</textarea>
                        </div>
                        <div class="curriculum-edit-form-group">
                            <label>Upload Image</label>
                            <div style="display:flex; gap:1rem; align-items:center;">
                                <input type="file" name="${nameBase}.ImageFile" accept="image/*" class="curriculum-edit-form-control" onchange="previewUploadImage(this)" />
                                <div class="curriculum-upload-preview" style="width:120px; height:80px; background:#eee; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:#aaa;">
                                    ${lessonData?.ExistingImageUrl ? `<img src="${lessonData.ExistingImageUrl}" style="max-width:100%; max-height:100%;" />` : '🖼️'}
                                </div>
                            </div>
                            <span class="file-error" style="display:none; color:red; font-size:0.9rem; margin-top:0.5rem;"></span>
                            <input type="hidden" name="${nameBase}.ExistingImageUrl" value="${lessonData?.ExistingImageUrl ?? lessonData?.MediaUrl ?? ''}" />
                        </div>`;

                // Interactive contents container (can have image uploads)
                html += `<div class="lesson-interactive-contents">
                            <h4>Interactive Contents</h4>
                            <div class="interactive-contents-container"></div>
                            <button type="button" class="curriculum-edit-add-btn" onclick="addLessonInteractiveContent(${moduleIndex}, ${lessonIndex})">+ Add Interactive Content</button>
                        </div>`;

                configContainer.innerHTML = html;

                // Preload existing interactive contents
                if(lessonData?.InteractiveContents?.length){
                    lessonData.InteractiveContents.forEach(ic => {
                        addLessonInteractiveContent(moduleIndex, lessonIndex, ic);
                    });
                }

                // Initialize TinyMCE for lesson content only (no image upload)
                const textareaImageText = configContainer.querySelector("textarea.tinymce-editor");
                if(textareaImageText){
                    initTinyMCE(textareaImageText, false); // ✅ disable image plugin for Image + Text lesson ContentText
                }

                // ✅ Reinitialize TinyMCE for all interactive content textareas
                setTimeout(() => {
                    const interactiveTextareas = configContainer.querySelectorAll(".interactive-contents-container textarea.tinymce-editor");
                    interactiveTextareas.forEach(ta => {
                        initTinyMCE(ta, true); // ✅ Enable image upload for interactive content
                    });
                }, 100);
                break;

            case 'Video + Text':
                html = `<div class="curriculum-edit-form-group">
                            <label>Content</label>
                            <textarea class="curriculum-edit-form-control tinymce-editor"
                                      name="${nameBase}.ContentText"
                                      rows="4" required>${lessonData?.ContentText || ''}</textarea>
                        </div>
                        <div class="curriculum-edit-form-group">
                            <label>Upload Video</label>
                            <div style="display:flex; gap:1rem; align-items:center;">
                                <input type="file" name="${nameBase}.VideoFile" accept="video/*" class="curriculum-edit-form-control" onchange="previewUploadVideo(this)" />
                                <div class="curriculum-upload-preview" style="width:120px; height:80px; background:#eee; display:flex; align-items:center; justify-content:center; font-size:1rem; color:#aaa;">
                                    ${lessonData?.ExistingVideoUrl  ? `<video src="${lessonData.ExistingVideoUrl}" style="max-width:100%; max-height:100%;" controls></video>` : '🎬'}
                                </div>
                            </div>
                            <input type="hidden" name="${nameBase}.ExistingVideoUrl" value="${lessonData?.ExistingVideoUrl ?? lessonData?.MediaUrl ?? ''}" />
                        </div>`;
                configContainer.innerHTML = html;
                break;

            case 'Quiz':
                html = `<div class="curriculum-edit-quiz-builder" data-namebase="${nameBase}">
                            <div class="curriculum-edit-quiz-questions"></div>
                            <button type="button" class="curriculum-edit-add-btn" onclick="curriculumEditAddQuizQuestion(this)">+ Add Question</button>
                        </div>`;
                configContainer.innerHTML = html;
                const quizBuilder = configContainer.querySelector(".curriculum-edit-quiz-builder");
                if(lessonData?.QuizQuestions?.length){
                    setTimeout(() => {
                        lessonData.QuizQuestions.forEach((q, i) => {
                            curriculumEditAddQuizQuestionToBuilder(quizBuilder.getAttribute("data-namebase"), q, i);
                        });
                    }, 0);
                }
                break;

            case 'Session':
                html = `<div class="curriculum-edit-form-group">
                            <label>This will be a live session learners can request.</label>
                        </div>`;
                configContainer.innerHTML = html;
                break;
        }

    }

        // ------------------ PREVIEW & FILE VALIDATION HANDLERS ------------------
    function previewUploadImage(input) {
        const previewDiv = input.parentNode.querySelector(".curriculum-upload-preview");
        const errorSpan = input.closest(".curriculum-edit-form-group").querySelector(".file-error");
        const file = input.files[0];
        const maxSizeMB = 20; // 20 MB
        const allowedTypes = ['image/jpeg','image/png','image/gif','image/webp'];

        if(!file) return;

        if(!allowedTypes.includes(file.type)){
            if(errorSpan) {
                errorSpan.textContent = "Invalid file type. Allowed: JPEG, PNG, GIF, WebP.";
                errorSpan.style.display='block';
            }
            input.value = '';
            previewDiv.innerHTML = '🖼️';
            return;
        }

        if(file.size > maxSizeMB * 1024 * 1024){
            if(errorSpan) {
                errorSpan.textContent = `File too large. Max ${maxSizeMB} MB.`;
                errorSpan.style.display='block';
            }
            input.value = '';
            previewDiv.innerHTML = '🖼️';
            return;
        }

        if(errorSpan) errorSpan.style.display='none';

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.maxWidth = "100%";
        img.style.maxHeight = "100%";
        previewDiv.innerHTML = '';
        previewDiv.appendChild(img);
    }

    function previewUploadVideo(input) {
        const previewDiv = input.parentNode.querySelector(".curriculum-upload-preview");
        const errorSpan = input.closest(".curriculum-edit-form-group").querySelector(".file-error");
        const file = input.files[0];
        const maxSizeMB = 200;
        const allowedTypes = ['video/mp4', 'video/webm', 'video/ogg', 'video/quicktime'];

        if(!file) return;

        if(!allowedTypes.includes(file.type)){
            if(errorSpan){
                errorSpan.textContent = "Invalid file type. Allowed: MP4, WebM, OGG, MOV.";
                errorSpan.style.display = 'block';
            }
            input.value = '';
            previewDiv.innerHTML = '🎬';
            return;
        }

        if(file.size > maxSizeMB * 1024 * 1024){
            if(errorSpan){
                errorSpan.textContent = `File too large. Max ${maxSizeMB}MB.`;
                errorSpan.style.display = 'block';
            }
            input.value = '';
            previewDiv.innerHTML = '🎬';
            return;
        }

        if(errorSpan) errorSpan.style.display = 'none';

        const video = document.createElement("video");
        video.src = URL.createObjectURL(file);
        video.style.maxWidth = "100%";
        video.style.maxHeight = "100%";
        video.controls = true;
        previewDiv.innerHTML = '';
        previewDiv.appendChild(video);
    }

    // ------------------ QUIZ FUNCTIONS ------------------
    function curriculumEditAddQuizQuestion(button){
        const builder = button.closest(".curriculum-edit-quiz-builder");
        const container = builder.querySelector(".curriculum-edit-quiz-questions");
        const nameBase = builder.getAttribute("data-namebase");
        const index = container.children.length;
        curriculumEditAddQuizQuestionToBuilder(nameBase, null, index);
    }

    function curriculumEditAddQuizQuestionToBuilder(nameBase, questionData = null, index){
        const container = document.querySelector(`[data-namebase='${nameBase}'] .curriculum-edit-quiz-questions`);
        const qBlock = document.createElement("div");
        qBlock.className = "curriculum-edit-quiz-question";

        qBlock.innerHTML = `
            <button type="button" class="curriculum-edit-quiz-delete-btn" onclick="showDeleteModal('quiz question', () => { this.closest('.curriculum-edit-quiz-question').remove(); curriculumEditRenumberQuizQuestions(this.closest('.curriculum-edit-quiz-builder')); })">🗑️</button>
            <div class="curriculum-edit-form-group">
                <label>Question ${index+1} *</label>
                <input type="text" name="${nameBase}.QuizQuestions[${index}].QuestionText" class="curriculum-edit-form-control" value="${questionData?.QuestionText || ''}" required />
            </div>
            <div class="curriculum-edit-form-group">
                <label>Options *</label>
                <div class="curriculum-edit-form-row">
                ${['A','B','C','D'].map((letter, i) => {
                    const val = questionData ? questionData[`Option${letter}`] || '' : '';
                    return `<div style="flex:1;">
                        <input type="text" name="${nameBase}.QuizQuestions[${index}].Option${letter}" class="curriculum-edit-form-control" placeholder="Option ${letter}" value="${val}" required />
                        <input type="radio"
                                name="${nameBase}.QuizQuestions[${index}].CorrectAnswer"
                                data-letter="${letter}"
                                value="${val}"
                                ${questionData?.CorrectAnswer === val || (!questionData?.CorrectAnswer && i===0) ? 'checked' : ''} required required/> Correct
                    </div>`;
                }).join('')}
                </div>
            </div>
                    `;
        container.appendChild(qBlock);

        // Add listener so radio value updates if option text changes
        ['A','B','C','D'].forEach(letter => {
            const optInput = qBlock.querySelector(`input[name$='Option${letter}']`);
            const radio = qBlock.querySelector(`input[type='radio'][data-letter='${letter}']`);

            if(optInput && radio){
                radio.value = optInput.value;
                if(!questionData?.CorrectAnswer && letter==='A') radio.checked = true;

                optInput.addEventListener('input', e => {
                    radio.value = e.target.value;
                    // preserve checked state
                    if(radio.checked) radio.checked = true;
                });
            }
        });

        curriculumEditRenumberQuizQuestions(container.closest(".curriculum-edit-quiz-builder"));
    }

    function curriculumEditRenumberQuizQuestions(builder){
        if(!builder) return; // Prevent null errors
        const container = builder.querySelector(".curriculum-edit-quiz-questions");
        if(!container) return;

        const nameBase = builder.getAttribute("data-namebase");
        const questions = container.querySelectorAll(".curriculum-edit-quiz-question");

        questions.forEach((qBlock, i) => {
            const questionTextInput = qBlock.querySelector("input[name$='.QuestionText']");
            if(questionTextInput) questionTextInput.name = `${nameBase}.QuizQuestions[${i}].QuestionText`;

            ['A','B','C','D'].forEach(letter => {
                const optInput = qBlock.querySelector(`input[name$='Option${letter}']`);
                const radio = qBlock.querySelector(`input[type='radio'][name$='CorrectAnswer'][data-letter='${letter}']`);
                if(radio && optInput) radio.value = optInput.value;
            });
        });
    }

    // ------------------ PRELOAD MODULES & FINAL PROJECT ------------------
    document.addEventListener("DOMContentLoaded", () => {

        if (typeof tinymce !== 'undefined') {
            tinymce.remove(); // Remove all instances
        }

        const modules = @Html.Raw(JsonSerializer.Serialize(Model.Modules ?? []));
        modules.forEach(m => curriculumEditAddModule(m));

        // Set first module active by default
        activeModuleIndex = 0;
        renderModuleTabs();
        renderModuleLessons(activeModuleIndex);

        const fpData = @Html.Raw(JsonSerializer.Serialize(Model.FinalProject ?? new SkillBuilder.Models.ViewModels.FinalProjectViewModel()));
        const fpTitle = document.querySelector("input[name='FinalProject.Title']");
        const fpDesc = document.querySelector("textarea[name='FinalProject.Description']");
        if(fpTitle) fpTitle.value = fpData.Title || '';
        if(fpDesc) fpDesc.value = fpData.Description || '';

        const form = document.getElementById("edit-course-form");
        const submitBtn = document.getElementById("editBtn");

        function validateCurriculumEditForm() {
            let allValid = true;

            // Validate all required inputs (visible fields only)
            const requiredFields = form.querySelectorAll("input[required], select[required], textarea[required]");
            requiredFields.forEach(f => {
                if(f.offsetParent !== null && (!f.value || f.value.trim() === "")) allValid = false;
            });

            // Validate modules (exclude final project)
            const modulesEls = form.querySelectorAll(".curriculum-edit-module:not(#curriculum-edit-final-project-module)");
            if(modulesEls.length < 2) allValid = false;

            modulesEls.forEach(mod => {
                const lessons = mod.querySelectorAll(".curriculum-edit-lesson-block");
                lessons.forEach(lesson => {
                    const lessonTitle = lesson.querySelector("input[name$='.Title']");
                    const lessonType = lesson.querySelector("select[name$='.LessonType']");
                    const lessonDuration = lesson.querySelector("input[name$='.DurationValue']");
                    const lessonUnit = lesson.querySelector("select[name$='.DurationUnit']");
                    if(!lessonTitle || !lessonTitle.value.trim()) allValid=false;
                    if(!lessonType || !lessonType.value) allValid=false;
                    if(!lessonDuration || !lessonDuration.value.trim()) allValid=false;
                    if(!lessonUnit || !lessonUnit.value) allValid=false;

                    const quizQuestions = lesson.querySelectorAll(".curriculum-edit-quiz-question input[type='text']");
                    quizQuestions.forEach(q => {
                        if(!q || !q.value.trim()) allValid = false;
                    });
                });
            });

            // Validate session lessons (max 1 session)
            const sessionLessons = document.querySelectorAll(".curriculum-edit-module .curriculum-edit-lesson-block select");
            let sessionCount = 0;
            sessionLessons.forEach(s => { if(s.value === "Session") sessionCount++; });
            if(sessionCount > 1) allValid = false;

            // Validate Final Project (even if tab not active)
            if(!fpTitle || !fpTitle.value.trim()) allValid=false;
            if(!fpDesc || !fpDesc.value.trim()) allValid=false;

            // Enable/disable submit button
            submitBtn.disabled = !allValid;

            // Show warning if less than 2 modules
            const warning = document.getElementById("curriculum-edit-module-warning");
            if(warning) warning.style.display = modulesEls.length < 2 ? "block" : "none";
        }

        validateCurriculumEditForm();

        // Re-validate on input/change
        form.addEventListener("input", validateCurriculumEditForm);
        form.addEventListener("change", validateCurriculumEditForm);

        // Observe dynamic changes (e.g., adding/removing lessons/modules)
        const observer = new MutationObserver(validateCurriculumEditForm);
        observer.observe(form, {childList:true, subtree:true});

    });

</script>