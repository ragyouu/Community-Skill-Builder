@model SkillBuilder.Models.ViewModels.CourseBuilderViewModel

<style>
    .material-add-btn-wrapper {
        text-align: right;
        margin-top: 1.5rem;
    }

    .material-add-btn {
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        font-weight: 600;
        color: #344AEA;
        background-color: transparent;
        border: 1.5px solid #344AEA;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

        .material-add-btn:hover {
            background-color: #344AEA;
            color: white;
        }

    .material-entry {
        border: 1px solid #ccc;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 8px;
    }

    .material-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .material-title {
        font-size: 1.1rem;
    }

    .material-delete {
        background: none;
        border: none;
        color: #888;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .material-fields {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-bottom: 1rem;
    }

    .material-form-group {
        flex: 1;
    }

        .material-form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }

        .material-form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid #aaa;
            border-radius: 6px;
        }

    .material-upload-wrapper {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

        .material-upload-wrapper input[type="file"] {
            flex: 1;
        }

        .material-upload-wrapper button {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            background-color: #E0EDFF;
            color: #1957D2;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

    .material-description {
        margin-top: 1rem;
    }
</style>

<div class="material-section">
    <div id="material-list"></div>
    <div class="material-add-btn-wrapper">
        <button type="button" class="material-add-btn" onclick="addMaterial()">+ Add Material</button>
    </div>
</div>

<script>
    let materialIndex = 0;

    const maxFileSize = 100 * 1024 * 1024; // 100 MB

    function validateMaterialFile(input) {
        const file = input.files[0];
        const errorEl = input.parentElement.querySelector(".file-error");

        if (!file) {
            errorEl.style.display = "none";
            return true;
        }

        if (file.size > maxFileSize) {
            errorEl.textContent = `File too large. Max ${(maxFileSize / (1024*1024)).toFixed(0)} MB allowed.`;
            errorEl.style.display = "block";
            input.value = "";
            return false;
        }

        errorEl.style.display = "none";
        return true;
    }

    function addMaterial(preloadData) {
        const list = document.getElementById("material-list");
        const index = materialIndex++;

        const container = document.createElement("div");
        container.className = "material-entry";
        container.setAttribute("data-index", index);

        const titleValue = preloadData?.Title ?? "";
        const descValue = preloadData?.Description ?? "";
        const idValue = preloadData?.Id ?? 0;
        let fileName = preloadData?.FileName ?? "";

        // Limit preloaded file name to 10 characters
        if (fileName.length > 10) {
            fileName = fileName.substring(0, 10) + "...";
        }

        const filePath = preloadData?.FilePath ?? "";

        container.innerHTML = `
            <!-- Hidden inputs -->
            <input type="hidden" name="Materials[${index}].Id" value="${idValue}" />
            <input type="hidden" name="Materials[${index}].FileName" value="${fileName}" />
            <input type="hidden" name="Materials[${index}].FilePath" value="${filePath}" />

            <div class="material-header">
                <span class="material-title">Material ${index + 1}</span>
                <button type="button" class="material-delete" onclick="removeMaterial(${index})">🗑️</button>
            </div>
            <div class="material-fields">
                <div class="material-form-group">
                    <label>Material Title</label>
                    <input type="text" name="Materials[${index}].Title" placeholder="Sample course material.pdf" value="${titleValue}" />
                </div>
                <div class="material-form-group">
                    <label>Upload File</label>
                    <div class="material-upload-wrapper">
                        <input type="file" name="Materials[${index}].UploadFile"
                               accept=".doc,.docx,.pdf"
                               onchange="validateMaterialFile(this)" />
                        <span class="file-error" style="color:red; font-size:0.85rem; display:none;"></span>
                    </div>
                </div>
            </div>
            <div class="material-form-group material-description">
                <label>Description</label>
                <input type="text" name="Materials[${index}].Description" placeholder="Add a description..." value="${descValue}" />
            </div>
        `;

        list.appendChild(container);
        renumberMaterials();
    }

    function removeMaterial(index) {
        const item = document.querySelector(`.material-entry[data-index='${index}']`);
        if (!item) return;

        const idInput = item.querySelector("input[name*='Id']");
        if (idInput && idInput.value != "0") {
            const form = document.getElementById("edit-course-form");
            if (form) {
                const deleteInput = document.createElement("input");
                deleteInput.type = "hidden";
                deleteInput.name = "MaterialsToDelete";
                deleteInput.value = idInput.value;
                form.appendChild(deleteInput);
            }
        }

        item.remove();
        renumberMaterials();
    }

    function renumberMaterials() {
        const materials = document.querySelectorAll('.material-entry');
        materials.forEach((entry, i) => {
            entry.setAttribute("data-index", i);

            const titleSpan = entry.querySelector(".material-title");
            if (titleSpan) titleSpan.textContent = `Material ${i + 1}`;

            const idInput = entry.querySelector("input[name*='Id']");
            const titleInput = entry.querySelector("input[name*='Title']");
            const fileInput = entry.querySelector("input[type='file']");
            const descInput = entry.querySelector("input[name*='Description']");
            const fileNameInput = entry.querySelector("input[name*='FileName']");
            const deleteBtn = entry.querySelector(".material-delete");

            if (idInput) idInput.name = `Materials[${i}].Id`;
            if (titleInput) titleInput.name = `Materials[${i}].Title`;
            if (fileInput) fileInput.name = `Materials[${i}].UploadFile`;
            if (descInput) descInput.name = `Materials[${i}].Description`;
            if (fileNameInput) fileNameInput.name = `Materials[${i}].FileName`;
            if (deleteBtn) deleteBtn.setAttribute("onclick", `removeMaterial(${i})`);
        });

        materialIndex = materials.length;
    }

    // Preload existing materials from model
    document.addEventListener("DOMContentLoaded", () => {
        const preloadMaterials = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Materials ?? []));
        preloadMaterials.forEach(mat => addMaterial(mat));
    });
</script>