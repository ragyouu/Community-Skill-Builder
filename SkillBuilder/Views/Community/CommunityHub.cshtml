@using SkillBuilder.Data
@using Microsoft.EntityFrameworkCore
@inject AppDbContext _context
@model SkillBuilder.Models.ViewModels.CommunityHubViewModel

@{
    ViewData["Title"] = "Community Hub";

    // Default values
    bool isDeactivated = false;
    bool isVerified = false;
    bool isAdmin = User.IsInRole("Admin");
    var currentUserRole = User.IsInRole("Artisan") ? "artisan" : "learner";

    // Get current user from DB
    var userId = User.FindFirst("UserId")?.Value;
    if (!string.IsNullOrEmpty(userId))
    {
        var user = await _context.Users.FirstOrDefaultAsync(u => u.Id == userId);
        if (user is not null)
        {
            isDeactivated = user.IsDeactivated;
            isVerified = user.IsVerified;
        }
    }
}

<style>
    /* Wrapper for the page */
    .community-page-wrapper {
        margin: 5.5rem 10%;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Header */
    .community-header h1 {
        font-size: 2rem;
        margin-bottom: 0.25rem;
        font-weight: bold;
    }

    .community-header h5 {
        color: #555;
        font-size: 1rem;
    }

    /* Search + Create Post row */
    .community-top-row {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
    }

    .community-search {
        width: 85%;
        display: flex;
        gap: 0.5rem;
    }

        .community-search input {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .community-search button {
            background-color: #344aeb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

    .create-post-btn {
        width: 12%;
        background-color: white;
        color: black;
        font-weight: 600;
        border: 1px solid;
        border-radius: 6px;
        cursor: pointer;
        padding: 0.5rem;
    }

    /* Left + Right sections */
    .community-body {
        display: flex;
        gap: 2rem;
    }

    .left-section {
        width: 80%;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .right-section {
        width: 20%;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .community-page-wrapper.no-right-section .left-section {
        width: 100%;
    }

    /* Make search bar fill space when no right section */
    .community-page-wrapper.no-right-section .community-search {
        width: 100%;
    }

    /* Tabs */
    .community-tabs {
        display: flex;
        gap: 2rem;
        border-bottom: 1px solid #ccc;
        margin-bottom: 1rem;
    }

    .community-tab {
        padding: 0.6rem 1.25rem;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
        color: #333;
    }

        .community-tab.active {
            border-bottom-color: #344AEA;
            background-color: #e6f0ff;
            color: #344AEA;
        }

    /* Tab panels */
    .community-tab-panel {
        display: none;
    }

        .community-tab-panel.active {
            display: block;
        }

    /* Full-width community details */
    .community-details-fullpage {
        width: 100%;
        margin: 0 auto;
        padding: 1rem 10%;
    }

    /* Right section cards */
    .right-card {
        background-color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .popular-communities,
    .user-communities {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

        .user-communities li span {
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .popular-communities li,
        .user-communities li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

    .community-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #d3d3e0;
    }

    .members-count {
        font-size: 0.85rem;
        color: #555;
    }

    .see-more-btn {
        background: none;
        border: 1px solid #4c6ef5;
        color: #4c6ef5;
        border-radius: 6px;
        padding: 0.5rem;
        cursor: pointer;
    }

    /* Create community card */
    .create-community-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        border: 2px dashed #ccc;
        border-radius: 12px;
        cursor: pointer;
        transition: border-color 0.2s, background-color 0.2s;
        text-align: center;
    }

        .create-community-card:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

    .plus-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .create-community-text small.threads-required {
        display: block;
        font-size: 0.8rem;
        color: #555;
        margin-top: 0.25rem;
        transition: color 0.2s;
    }

    .create-community-card:hover .threads-required {
        color: white;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.4);
        z-index: 1001;
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }

    .modal-content {
        background: #fff;
        border-radius: 12px;
        width: 100%;
        max-width: 800px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        cursor: pointer;
        color: #555;
    }

    .modal h2 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
    }

    .modal-subtitle {
        margin-bottom: 1.5rem;
        color: #555;
        font-size: 0.95rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }

        .form-group label {
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

    .required {
        color: red;
    }

    .form-group input,
    .form-group textarea {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        width: 100%;
        resize: none;
        box-sizing: border-box;
    }

    textarea {
        min-height: 120px;
    }

    .char-count {
        text-align: right;
        font-size: 0.75rem;
        color: #888;
        margin-top: 0.25rem;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .cancel-btn {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 0.5rem 1.25rem;
        cursor: pointer;
        font-weight: 600;
    }

    .next-btn {
        background: #344AEA;
        border: none;
        color: white;
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

        .next-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    .category-card {
        padding: 1rem 1.5rem;
        background-color: #f1f1f1;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        flex: 1 0 18%; /* roughly 5 cards horizontally */
        text-align: center;
        font-weight: 600;
    }

        .category-card.selected {
            background-color: #344AEA;
            color: white;
            transform: scale(1.05);
        }

    .community-posts-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    .community-posts-modal-content {
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        width: 600px;
        max-width: 95%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .community-posts-title {
        font-size: 1.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: .25rem;
    }

    .community-posts-subtitle {
        text-align: center;
        color: #555;
        margin-bottom: 1.5rem;
    }

    .community-posts-field {
        margin-bottom: 1.5rem;
    }

        .community-posts-field label {
            display: block;
            font-weight: 600;
            margin-bottom: .5rem;
        }

        .community-posts-field input,
        .community-posts-field textarea {
            width: 100%;
            padding: .75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: .95rem;
        }

    .community-posts-charcount {
        font-size: .8rem;
        color: #888;
        float: right;
        margin-top: .25rem;
    }

    .community-posts-categories {
        display: flex;
        gap: .5rem;
        flex-wrap: wrap;
        margin: .5rem 0;
    }

    .community-posts-category {
        border: 1px solid #ccc;
        background: #f9f9f9;
        padding: .5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all .2s;
    }

        .community-posts-category:hover {
            background: #eee;
        }

        .community-posts-category.active {
            border-color: #344AEA;
            background: #e6ecff;
            color: #344AEA;
            font-weight: 600;
        }

    .community-posts-other {
        display: inline-block;
        margin-top: .5rem;
        font-size: .9rem;
        color: #344AEA;
        text-decoration: none;
    }

        .community-posts-other:hover {
            text-decoration: underline;
        }

    .community-posts-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .community-posts-btn {
        padding: .6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        border: none;
    }

        .community-posts-btn.primary {
            background: #344AEA;
            color: #fff;
        }

        .community-posts-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .community-posts-btn:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

    #bannerPreview {
        width: 100%;
        max-width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        display: none;
    }

    /* Hover effect for Create Post button */
    .create-post-btn:hover {
        background-color: #344aeb; /* blue background */
        color: white;
        transition: all 0.2s ease;
    }

    /* Hover effect for Create Community card */
    #createCommunityModal,
    #createCommunityModal:hover {
    }

        /* Specifically for the card */
        #createCommunityModal + .create-community-card,
        #createCommunityModal + .create-community-card:hover,
        #createCommunityModal + .create-community-card:focus {
        }

    .create-community-card:hover {
        background-color: #344aeb;
        color: white;
        transition: all 0.2s ease;
    }

    #Category {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 0.9rem;
        width: 100%;
        box-sizing: border-box;
    }

    #communityPostsCategorySelect {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 0.9rem;
        width: 100%;
        box-sizing: border-box;
    }

    /* Overlay */
    .community-modal-confirm-threads-overlay {
        position: fixed;
        inset: 0;
        display: none; /* hidden by default */
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,0.5);
        z-index: 9999;
    }

        /* Show modal */
        .community-modal-confirm-threads-overlay.show {
            display: flex;
        }

    /* Modal content */
    .community-modal-confirm-threads-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 1rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        text-align: center;
    }

    /* Modal text */
    .community-modal-confirm-threads-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .community-modal-confirm-threads-text {
        font-size: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Buttons */
    .community-modal-confirm-threads-buttons {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }

    .community-modal-confirm-threads-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

        .community-modal-confirm-threads-btn.cancel {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
        }

        .community-modal-confirm-threads-btn.confirm {
            background-color: #3b82f6;
            color: #fff;
        }

        .community-modal-confirm-threads-btn:hover {
            opacity: 0.9;
        }

</style>

<div class="community-page-wrapper @(isAdmin ? "no-right-section" : "")">

    @if (Model.SelectedCommunity != null)
    {
        <div class="community-details-fullpage">
            @{
                var community = Model.SelectedCommunity;
                var currentUserId = User.FindFirst("UserId")?.Value;
                var detailsVm = new SkillBuilder.Models.ViewModels.CommunityDetailsViewModel
                {
                    SelectedCommunity = community,
                    IsOwner = community.CreatorId == currentUserId,
                    IsJoined = community.Memberships.Any(m => m.UserId == currentUserId),
                    Posts = Model.Posts // optional, if you want posts here
                };
            }

            @Html.Partial("~/Views/Shared/Sections/_CommunityDetailsSection.cshtml", detailsVm)
        </div>
    }
    else
    {
        <div class="community-header">
            <h1>Community Hub</h1>
            <h5>Connect with fellow artisans, students, and enthusiasts to share experiences, showcase your work, and learn together.</h5>
        </div>

        <div class="community-top-row">
            <div class="community-search">
                <input type="text" id="searchPostsInput" placeholder="Search posts..." />
                <button id="searchPostsBtn"><img src="/assets/Icons/Search.ico" width="20" height="20" /></button>
            </div>
            @if (isAdmin)
            {
                <!-- Admins cannot create posts -->
            }
            else if (isDeactivated || !isVerified)
            {
                <button class="create-post-btn" disabled style="opacity:0.5; cursor:not-allowed;">
                    ＋ Create Post
                </button>
            }
            else
            {
                <button class="create-post-btn">＋ Create Post</button>
            }
        </div>

        <div class="community-body">
            <div class="left-section">
                <div class="community-tabs">
                    <button type="button" class="community-tab active" data-tab="posts">Posts</button>

                    @if (!isAdmin)
                    {
                        <button type="button" class="community-tab" data-tab="communities">Communities</button>
                    }
                </div>

                <div class="community-tab-panel active" data-tab="posts">
                    <partial name="Sections/CommunityNotebooks/_CommunityNotebookPosts" model="Model.Posts" />
                </div>

                @if (!isAdmin)
                {
                    <div class="community-tab-panel" data-tab="communities">
                        <partial name="Sections/CommunityNotebooks/_CommunityNotebookCommunities" model="Model" />
                    </div>
                }
            </div>

            @if (!isAdmin)
            {
                <div class="right-section">
                    @if (isDeactivated || !isVerified)
                    {
                        <div class="create-community-card" style="opacity:0.5; pointer-events:none; cursor:not-allowed;">
                            <p style="color:#d00; font-size:0.85rem; margin-top:0.5rem;">
                                Can't Create Community, your account is either not verified or deactivated.
                            </p>
                        </div>
                    }
                    else
                    {
                        <div class="create-community-card" id="openCreateCommunityModal">
                            <span class="plus-icon">＋</span>
                            <div class="create-community-text">
                                <span>Create a community</span>
                                <small class="threads-required">Requires 100 threads</small>
                            </div>
                        </div>
                    }

                    <div class="right-card">
                        <h4>Your Communities</h4>
                        <ul class="user-communities">
                            @{
                                var currentUserId = User.FindFirst("UserId")?.Value;
                                var ownedCommunities = Model.Communities?
                                .Where(c => c.CreatorId == currentUserId)
                                .ToList() ?? new List<SkillBuilder.Models.ViewModels.CommunitiesViewModel>();
                            }

                            @if (ownedCommunities.Any())
                            {
                                foreach (var community in ownedCommunities)
                                {
                                    <li>
                                        <div class="community-avatar">
                                            <img src="@(!string.IsNullOrEmpty(community.AvatarUrl)
                                                                                                                                      ? community.AvatarUrl
                                                                                                                                      : "/uploads/community-profile/default-community.png")"
                                 alt="@community.Name"
                                 style="width:40px; height:40px; border-radius:50%;" />
                        </div>
                        <span>@community.Name</span>
                    </li>
                                        }
                            }
                            else
                            {
                                <li>No communities owned yet.</li>
                            }
                        </ul>
                    </div>
                </div>
            }

            <!-- Create Post Modal -->
            <div id="communityPostsCreateModal" class="community-posts-modal-overlay" style="display:none;">
                <div class="community-posts-modal-content">
                    <h2 class="community-posts-title">Create a Post</h2>
                    <p class="community-posts-subtitle">
                        Start a new topic or ask the community—someone might just have the answer or the same idea!
                    </p>

                    <form id="communityPostsForm" method="post" action="/Community/CreatePost"
                          enctype="multipart/form-data" novalidate>

                        <!-- Hidden fields -->
                        <input type="hidden" name="Category" id="communityPostsCategory" />

                        <!-- Title -->
                        <div class="community-posts-field">
                            <label for="communityPostsTitle">Start with a title.</label>
                            <input type="text" name="Title" id="communityPostsTitle" maxlength="100"
                                   placeholder="Please enter an appropriate Title :)" />
                            <small class="community-posts-charcount" id="communityPostsTitleCount">
                                0/100 maximum characters
                            </small>
                        </div>

                        <!-- Content -->
                        <div class="community-posts-field">
                            <label for="communityPostsContent">Provide more details.</label>
                            <textarea name="Content" id="communityPostsContent" maxlength="1000"
                                  placeholder="Provide more details"></textarea>
                            <small class="community-posts-charcount" id="communityPostsContentCount">
                                0/1000 maximum characters
                            </small>
                        </div>

                        <!-- Image -->
                        <div class="community-posts-field">
                            <label for="communityPostsImage">Attach an image (optional)</label>
                            <input type="file" name="Image" id="communityPostsImage" accept="image/*" />
                            <div id="communityPostsImagePreviewContainer" style="margin-top:0.5rem;">
                                <img id="communityPostsImagePreview" style="max-width:100%; border-radius:8px; display:none;" />
                            </div>
                        </div>

                        <!-- Category -->
                        <div class="community-posts-field">
                            <label for="communityPostsCategorySelect">Select a category</label>
                            <select id="communityPostsCategorySelect">
                                <option value="">-- Choose a category --</option>
                                <option value="Pottery">Pottery</option>
                                <option value="Weaving">Weaving</option>
                                <option value="Wood Carving">Wood Carving</option>
                                <option value="Paper Crafts">Paper Crafts</option>
                                <option value="Shoemaking">Shoemaking</option>
                                <option value="Embroidery">Embroidery</option>
                                <option value="Others">Others</option>
                            </select>

                            <input type="text" id="communityPostsOtherCategory" placeholder="Enter custom category"
                                   style="display:none;" />

                            <!-- This hidden input will hold the actual value for form submission -->
                            <input type="hidden" id="communityPostsCategory" name="Category" />
                        </div>

                        <!-- Actions -->
                        <div class="community-posts-actions">
                            <button type="submit" class="community-posts-btn primary" id="communityPostsSubmit" disabled>
                                Post
                            </button>
                            <button type="button" class="community-posts-btn secondary" id="communityPostsCancel">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal -->
            <div id="createCommunityModal" class="modal">
                <div class="modal-content">
                    <span id="closeModal" class="modal-close">×</span>

                    <form id="createCommunityForm" asp-action="Create" asp-controller="Community" method="post" enctype="multipart/form-data">

                        <!-- Step 1: Community Info -->
                        <div class="modal-step" id="step1">
                            <h2>Tell us about your community</h2>
                            <p class="modal-subtitle">A name and description help people understand what your community is all about.</p>

                            <div class="form-group">
                                <label for="communityName">Community name <span class="required">*</span></label>
                                <input type="text" name="Name" id="communityName" maxlength="100" placeholder="Community name" required />
                                <small class="char-count"><span id="nameCount">0</span>/100 maximum characters</small>
                            </div>

                            <div class="form-group">
                                <label for="communityDescription">Community description <span class="required">*</span></label>
                                <textarea name="Description" id="communityDescription" maxlength="1000" placeholder="Community description" required></textarea>
                                <small class="char-count"><span id="descCount">0</span>/1000 maximum characters</small>
                            </div>

                            <div class="modal-buttons">
                                <button type="button" class="cancel-btn">Cancel</button>
                                <button type="button" class="next-btn" disabled id="toStep2">Next</button>
                            </div>
                        </div>

                        <!-- Step 2: Style your community -->
                        <div class="modal-step" id="step2" style="display:none;">
                            <h2>Style your community</h2>
                            <p class="modal-subtitle">Customize your community's look to make it stand out.</p>

                            <div class="form-group">
                                <label>Banner</label>
                                <input type="file" name="Banner" id="bannerInput" accept="image/*" />
                                <div id="bannerPreviewContainer" style="position: relative; margin-top:0.5rem;">
                                    <img id="bannerPreview" style="max-width:100%; border-radius:8px; display:none;" />
                                    <button id="bannerDeleteBtn" style="display:none; position:absolute; top:5px; right:5px; background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">×</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Profile</label>
                                <input type="file" name="Avatar" id="profileInput" accept="image/*" />
                                <div id="profilePreviewContainer" style="position: relative; margin-top:0.5rem;">
                                    <img id="profilePreview" style="width:60px; height:60px; border-radius:50%; display:none;" />
                                    <button id="profileDeleteBtn" style="display:none; position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">×</button>
                                </div>
                            </div>

                            <div class="modal-buttons">
                                <button type="button" class="cancel-btn">Cancel</button>
                                <button type="button" class="next-btn" id="finishBtn">Next</button>
                            </div>
                        </div>

                        <!-- Step 3: Choose Category -->
                        <div class="modal-step" id="step3" style="display:none;">
                            <h2>Choose your category</h2>
                            <p class="modal-subtitle">Please select a category for your community.</p>

                            <div class="form-group" style="margin-bottom: 2rem;">
                                <label for="Category" class="form-label" style="font-weight:600;">Community Category</label>
                                <select id="Category" name="Category" class="form-select" onchange="handleCategoryChange(this)">
                                    <option value="">-- Select Category --</option>
                                    <option value="Pottery">Pottery</option>
                                    <option value="Weaving">Weaving</option>
                                    <option value="Wood Carving">Wood Crafts</option>
                                    <option value="Paper Crafts">Paper Crafts</option>
                                    <option value="Shoemaking">Shoemaking</option>
                                    <option value="Embroidery">Embroidery</option>
                                    <option value="Others">Others</option>
                                </select>
                            </div>

                            <div id="OtherCategoryWrapper" style="display:none; margin-bottom: 2rem;">
                                <label for="OtherCategory" class="form-label" style="font-weight:600;">Specify Category</label>
                                <input type="text" id="OtherCategory" name="OtherCategory"
                                       placeholder="Enter desired category"
                                       style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #ccc;" />
                            </div>

                            <input type="hidden" name="CategoryFinal" id="selectedCategory" />

                            <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                                <button type="button" class="cancel-btn">Cancel</button>
                                <button type="submit" class="next-btn" id="createCommunityBtn" disabled>Create Community</button>
                                <input type="hidden" id="currentUserThreads" value="120">
                                <input type="hidden" id="userRole" value="@currentUserRole">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
</div>

<!-- Confirmation Modal for Community Creation -->
<div id="community-modal-confirm-threads-overlay" class="community-modal-confirm-threads-overlay">
    <div class="community-modal-confirm-threads-content">
        <h2 class="community-modal-confirm-threads-title">Confirm Community Creation</h2>
        <p class="community-modal-confirm-threads-text">
            Creating this community will cost <span class="community-modal-confirm-threads-amount">100 threads</span>. Are you sure you want to continue?
        </p>
        <div class="community-modal-confirm-threads-buttons">
            <button id="community-modal-confirm-threads-cancel" class="community-modal-confirm-threads-btn cancel">Cancel</button>
            <button id="community-modal-confirm-threads-confirm" class="community-modal-confirm-threads-btn confirm">Yes, Create</button>
        </div>
    </div>
</div>

<!-- Insufficient Threads Modal -->
<div id="community-modal-insufficient-threads-overlay" class="community-modal-confirm-threads-overlay">
    <div class="community-modal-confirm-threads-content">
        <h2 class="community-modal-confirm-threads-title">Insufficient Threads</h2>
        <p class="community-modal-confirm-threads-text">
            You do not have enough threads to create a community. You need
            <span class="community-modal-confirm-threads-amount">100 threads</span>.
        </p>
        <div class="community-modal-confirm-threads-buttons">
            <button id="community-modal-insufficient-threads-cancel"
                    class="community-modal-confirm-threads-btn cancel">
                OK
            </button>
        </div>
    </div>
</div>

<script>
    function handleCategoryChange(select) {
        const otherWrapper = document.getElementById("OtherCategoryWrapper");
        const createBtn = document.getElementById("createCommunityBtn");
        const selectedCategoryInput = document.getElementById("selectedCategory");

        if (select.value === "Others") {
            otherWrapper.style.display = "block";
            createBtn.disabled = true; // wait for input
            selectedCategoryInput.value = "";
        } else if (select.value) {
            otherWrapper.style.display = "none";
            createBtn.disabled = false;
            selectedCategoryInput.value = select.value;
        } else {
            otherWrapper.style.display = "none";
            createBtn.disabled = true;
            selectedCategoryInput.value = "";
        }
    }


    document.addEventListener("DOMContentLoaded", () => {

        const currentUserThreads = document.getElementById("currentUserThreads");
        const isLearner = document.getElementById("userRole");
        const confirmThreadsOverlay = document.getElementById("community-modal-confirm-threads-overlay");
        const confirmThreadsBtn = document.getElementById("community-modal-confirm-threads-confirm");
        const cancelThreadsBtn = document.getElementById("community-modal-confirm-threads-cancel");
        const createCommunityBtn = document.getElementById("createCommunityBtn");
        if (!createCommunityBtn) return; // bail if button doesn't exist

        const form = createCommunityBtn.closest("form");
        if (!form) return;

        const insufficientThreadsOverlay = document.getElementById("community-modal-insufficient-threads-overlay");
        const insufficientThreadsCancelBtn = document.getElementById("community-modal-insufficient-threads-cancel");

        function openConfirmThreadsModal() {
            confirmThreadsOverlay.classList.add("show");
        }

        function closeConfirmThreadsModal() {
            confirmThreadsOverlay.classList.remove("show");
        }

        function openInsufficientThreadsModal() {
            insufficientThreadsOverlay.classList.add("show");
        }

        function closeInsufficientThreadsModal() {
            insufficientThreadsOverlay.classList.remove("show");
        }

        function canCreateCommunity() {
            const threads = parseInt(document.getElementById("currentUserThreads").value || "0");
            const userRole = document.getElementById("userRole")?.value; // "learner" or "artisan"

            // Artisans can create without thread limit
            if (userRole === "artisan") return true;

            // Learners need >= 100 threads
            return threads >= 100;
        }

        // Close buttons
        cancelThreadsBtn.addEventListener("click", closeConfirmThreadsModal);
        insufficientThreadsCancelBtn.addEventListener("click", closeInsufficientThreadsModal);

        // Handle confirmation modal "Yes, Create"
        confirmThreadsBtn.addEventListener("click", async () => {
            closeConfirmThreadsModal();

            // Submit the form via fetch
            const form = createCommunityBtn.closest("form");
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else if (result.insufficientThreads) {
                    openInsufficientThreadsModal();
                } else {
                    alert(result.message || "Something went wrong.");
                }
            } catch (err) {
                console.error(err);
                alert("Failed to create community. Please try again.");
            }
        });

        // Intercept form submission to show modal first
        createCommunityBtn.closest("form").addEventListener("submit", async function(e) {
            e.preventDefault(); // prevent default submit

            const userRole = document.getElementById("userRole")?.value;

            if (userRole === "artisan") {
                // Artisan → skip confirmation, submit immediately
                const form = this;
                const formData = new FormData(form);
                try {
                    const response = await fetch(form.action, {
                        method: "POST",
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        window.location.reload();
                    } else {
                        alert(result.message || "Something went wrong.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Failed to create community. Please try again.");
                }
                return;
            }

            // Learners → check threads
            if (!canCreateCommunity()) {
                openInsufficientThreadsModal();
                return;
            }

            // Learners → show confirmation modal
            openConfirmThreadsModal();
        });

        const otherCategoryInput = document.getElementById("OtherCategory");
        const createBtn = document.getElementById("createCommunityBtn");
        const selectedCategoryInput = document.getElementById("selectedCategory");

        if (otherCategoryInput && createBtn && selectedCategoryInput) {
            otherCategoryInput.addEventListener("input", function () {
                const inputVal = this.value.trim();

                if (inputVal.length > 0) {
                    createBtn.disabled = false;
                    selectedCategoryInput.value = inputVal;
                } else {
                    createBtn.disabled = true;
                    selectedCategoryInput.value = "";
                }
            });
        }

        // ================== CREATE COMMUNITY MODAL ==================
        const modal = document.getElementById("createCommunityModal");
        const openModalBtn = document.getElementById("openCreateCommunityModal");
        const closeModalBtn = document.querySelector(".modal-close");
        const cancelBtns = document.querySelectorAll(".cancel-btn");

        // Step elements
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const step3 = document.getElementById("step3");
        const toStep2 = document.getElementById("toStep2");

        const nameInput = document.getElementById("communityName");
        const descInput = document.getElementById("communityDescription");
        const nameCount = document.getElementById("nameCount");
        const descCount = document.getElementById("descCount");

        const bannerInput = document.getElementById("bannerInput");
        const profileInput = document.getElementById("profileInput");
        const bannerPreview = document.getElementById("bannerPreview");
        const profilePreview = document.getElementById("profilePreview");

        const finishBtn = document.getElementById("finishBtn");
        const finalCommunityName = document.getElementById("finalCommunityName");
        const finalCommunityDescription = document.getElementById("finalCommunityDescription");
        const finalBannerPreview = document.getElementById("finalBannerPreview");
        const finalProfilePreview = document.getElementById("finalProfilePreview");

        // ---- MODAL LOGIC ----
        if (modal && openModalBtn && closeModalBtn && step1 && step2 && step3) {
            // Open modal
            openModalBtn.addEventListener("click", () => modal.style.display = "flex");

            // Close modal function
            const closeModal = () => {
                modal.style.display = "none";
                step1.style.display = "block";
                step2.style.display = "none";
                step3.style.display = "none";

                // Reset form fields
                if (nameInput) nameInput.value = "";
                if (descInput) descInput.value = "";
                if (bannerInput) bannerInput.value = "";
                if (profileInput) profileInput.value = "";

                if (bannerPreview) {
                    bannerPreview.src = "";
                    bannerPreview.style.display = "none";
                }
                if (profilePreview) {
                    profilePreview.src = "";
                    profilePreview.style.display = "none";
                }
                if (toStep2) toStep2.disabled = true;
            };

            // Attach close events
            closeModalBtn.addEventListener("click", closeModal);
            cancelBtns.forEach(btn => btn.addEventListener("click", closeModal));
            window.addEventListener("click", e => { if (e.target === modal) closeModal(); });
            window.addEventListener("keydown", e => { if (e.key === "Escape") closeModal(); });

            // ---- STEP 1: Character counting ----
            if (nameInput && descInput && nameCount && descCount && toStep2) {
                const updateCharCount = () => {
                    nameCount.textContent = nameInput.value.length;
                    descCount.textContent = descInput.value.length;
                    toStep2.disabled = !(nameInput.value.trim() && descInput.value.trim());
                };
                nameInput.addEventListener("input", updateCharCount);
                descInput.addEventListener("input", updateCharCount);
                updateCharCount();
            }

            // ---- STEP 1 -> STEP 2 ----
            if (toStep2) {
                toStep2.addEventListener("click", () => {
                    step1.style.display = "none";
                    step2.style.display = "block";
                    checkStep2Ready();
                });
            }

            // ---- STEP 2: Handle image upload with validation (max 700 KB) ----
            const handleImageUpload = (input, previewImg, deleteBtn, maxSizeMB = 20) => {
                if (!input || !previewImg || !deleteBtn) return;

                // Create error message element
                let errorMsg = document.createElement("small");
                errorMsg.style.color = "red";
                errorMsg.style.display = "none";
                errorMsg.style.marginTop = "0.25rem";
                input.parentNode.appendChild(errorMsg);

                input.addEventListener("change", e => {
                    const file = e.target.files[0];
                    const maxSizeBytes = maxSizeMB * 1024 * 1024;

                    // Reset previous error
                    errorMsg.style.display = "none";
                    errorMsg.textContent = "";

                    if (!file) return;

                    if (!file.type.startsWith("image/")) {
                        errorMsg.textContent = "Only image files are allowed!";
                        errorMsg.style.display = "block";
                        input.value = "";
                        return;
                    }

                    if (file.size > maxSizeBytes) {
                        errorMsg.textContent = `File is too large. Maximum allowed size is ${maxSizeMB} MB.`;
                        errorMsg.style.display = "block";
                        input.value = "";
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = () => {
                        previewImg.src = reader.result;
                        previewImg.style.display = "block";
                        deleteBtn.style.display = "block";
                        checkStep2Ready();
                    };
                    reader.readAsDataURL(file);
                });

                deleteBtn.addEventListener("click", e => {
                    e.preventDefault();
                    e.stopPropagation();
                    input.value = "";
                    previewImg.src = "";
                    previewImg.style.display = "none";
                    deleteBtn.style.display = "none";
                    errorMsg.style.display = "none"; // hide error on delete
                    checkStep2Ready();
                });
            };

            // Apply to banner and profile inputs
            handleImageUpload(bannerInput, bannerPreview, document.getElementById("bannerDeleteBtn"), 20);
            handleImageUpload(profileInput, profilePreview, document.getElementById("profileDeleteBtn"), 20);

            // ---- STEP 2: Enable Finish only if both images selected ----
            const checkStep2Ready = () => {
                if (finishBtn) {
                    finishBtn.disabled = !(bannerInput?.files?.length && profileInput?.files?.length);
                }
            };
            checkStep2Ready();

            // ---- STEP 2 -> STEP 3 ----
            if (finishBtn) {
                finishBtn.addEventListener("click", () => {
                    if (!(bannerInput?.files?.length && profileInput?.files?.length)) return;

                    step2.style.display = "none";
                    step3.style.display = "block";
                });
            }

            // ---- STEP 3: Category selection ----
            const categoryCards = document.querySelectorAll(".category-card");
            const hiddenCategoryInput = document.getElementById("selectedCategory");

            if (categoryCards.length && createCommunityBtn && hiddenCategoryInput) {
                categoryCards.forEach(card => {
                    card.addEventListener("click", () => {
                        categoryCards.forEach(c => c.classList.remove("selected"));
                        card.classList.add("selected");
                        hiddenCategoryInput.value = card.dataset.category;
                        createCommunityBtn.disabled = false;
                    });
                });
            }
        }

        // ================== CREATE POST MODAL ==================
        const createPostBtn = document.querySelector(".create-post-btn");
        const postModal = document.getElementById("communityPostsCreateModal");
        const cancelPostBtn = document.getElementById("communityPostsCancel");
        const submitPostBtn = document.getElementById("communityPostsSubmit");
        const titleInputPost = document.getElementById("communityPostsTitle");
        const contentInputPost = document.getElementById("communityPostsContent");
        const titleCountPost = document.getElementById("communityPostsTitleCount");
        const contentCountPost = document.getElementById("communityPostsContentCount");
        const imageInput = document.getElementById("communityPostsImage");
        const imagePreview = document.getElementById("communityPostsImagePreview");

        // New dropdown & others input
        const categorySelect = document.getElementById("communityPostsCategorySelect");
        const otherpostCategoryInput = document.getElementById("communityPostsOtherCategory");
        const hiddenCategoryInput = document.getElementById("communityPostsCategory");

        const MAX_IMAGE_MB = 20;
        let selectedCategoryPost = null;

        // Open modal
        if (createPostBtn && postModal) {
            createPostBtn.addEventListener("click", () => {
                postModal.style.display = "flex";
            });
        }

        // Close modal helper
        const closePostModal = () => {
            if (postModal) postModal.style.display = "none";
            if (titleInputPost) titleInputPost.value = "";
            if (contentInputPost) contentInputPost.value = "";
            if (titleCountPost) titleCountPost.textContent = "0/100 maximum characters";
            if (contentCountPost) contentCountPost.textContent = "0/1000 maximum characters";
            if (categorySelect) categorySelect.value = "";
            if (otherpostCategoryInput) {
                otherpostCategoryInput.value = "";
                otherpostCategoryInput.style.display = "none";
            }
            if (hiddenCategoryInput) hiddenCategoryInput.value = "";
            selectedCategoryPost = null;
            if (submitPostBtn) submitPostBtn.disabled = true;
            if (imageInput) {
                imageInput.value = "";
                imagePreview.src = "";
                imagePreview.style.display = "none";
                if (imageInput.nextElementSibling?.classList.contains("image-error")) {
                    imageInput.nextElementSibling.remove();
                }
            }
        };

        // Close events
        if (cancelPostBtn) cancelPostBtn.addEventListener("click", closePostModal);
        if (postModal) {
            postModal.addEventListener("click", e => { if (e.target === postModal) closePostModal(); });
        }
        window.addEventListener("keydown", e => { if (e.key === "Escape") closePostModal(); });

        // Character counters
        if (titleInputPost) titleInputPost.addEventListener("input", validatePostForm);
        if (contentInputPost) contentInputPost.addEventListener("input", validatePostForm);

        // Image preview with validation
        if (imageInput && imagePreview) {
            let errorMsg = document.createElement("small");
            errorMsg.classList.add("image-error");
            errorMsg.style.color = "red";
            errorMsg.style.display = "none";
            errorMsg.style.marginTop = "0.25rem";
            imageInput.parentNode.appendChild(errorMsg);

            imageInput.addEventListener("change", e => {
                const file = e.target.files[0];
                errorMsg.style.display = "none";
                errorMsg.textContent = "";

                if (!file) {
                    imagePreview.src = "";
                    imagePreview.style.display = "none";
                    validatePostForm();
                    return;
                }

                if (!file.type.startsWith("image/")) {
                    errorMsg.textContent = "Only image files are allowed!";
                    errorMsg.style.display = "block";
                    imageInput.value = "";
                    imagePreview.src = "";
                    imagePreview.style.display = "none";
                    return;
                }

                if (file.size > MAX_IMAGE_MB * 1024 * 1024) {
                    errorMsg.textContent = `File is too large. Maximum allowed size is ${MAX_IMAGE_MB} MB.`;
                    errorMsg.style.display = "block";
                    imageInput.value = "";
                    imagePreview.src = "";
                    imagePreview.style.display = "none";
                    return;
                }

                const reader = new FileReader();
                reader.onload = () => {
                    imagePreview.src = reader.result;
                    imagePreview.style.display = "block";
                };
                reader.readAsDataURL(file);

                validatePostForm();
            });
        }

        // ----------------- CATEGORY DROPDOWN -----------------
        if (categorySelect && otherpostCategoryInput && hiddenCategoryInput) {
            categorySelect.addEventListener("change", () => {
                const val = categorySelect.value;
                if (val === "Others") {
                    otherpostCategoryInput.style.display = "block";
                    hiddenCategoryInput.value = "";
                    selectedCategoryPost = null; // important
                    submitPostBtn.disabled = true;
                } else if (val) {
                    otherpostCategoryInput.style.display = "none";
                    otherpostCategoryInput.value = "";
                    hiddenCategoryInput.value = val;
                    selectedCategoryPost = val; // ✅ update here
                    validatePostForm();
                } else {
                    otherpostCategoryInput.style.display = "none";
                    hiddenCategoryInput.value = "";
                    selectedCategoryPost = null;
                    submitPostBtn.disabled = true;
                }
            });

            otherpostCategoryInput.addEventListener("input", () => {
                const val = otherpostCategoryInput.value.trim();
                hiddenCategoryInput.value = val;
                selectedCategoryPost = val ? val : null;
                validatePostForm();
            });
        }

        // Validation & enabling submit
        function validatePostForm() {
            const title = titleInputPost?.value.trim();
            const content = contentInputPost?.value.trim();
            const category = selectedCategoryPost;
            submitPostBtn.disabled = !(title && content && category);
            if (titleCountPost) titleCountPost.textContent = `${titleInputPost.value.length}/100 maximum characters`;
            if (contentCountPost) contentCountPost.textContent = `${contentInputPost.value.length}/1000 maximum characters`;
        }

        // Form submission
        const communityPostsForm = document.getElementById("communityPostsForm");
        if (communityPostsForm) {
            communityPostsForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                try {
                    const response = await fetch(form.action, {
                        method: "POST",
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        // ✅ Create new post element
                        const newPost = document.createElement("div");
                        newPost.classList.add("post-card");
                        newPost.innerHTML = `
                            <div class="post-card-header">
                                <div class="avatar" style="background-image:url('${result.post.authorAvatarUrl}')"></div>
                                <div class="community-info">
                                    <h5>${result.post.authorName}</h5>
                                    <h6>${result.post.communityName} • ${new Date(result.post.submittedAt).toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' })}</h6>
                                </div>
                            </div>
                            <div class="post-card-content">
                                <p>${result.post.content}</p>
                                ${result.post.imageUrl ? `<img src="${result.post.imageUrl}" alt="Post image" />` : ""}
                                <div class="community-meta">
                                    <span>💬 0</span>
                                </div>
                            </div>
                        `;

                        const postsContainer = document.querySelector('.community-posts-list');
                        if (postsContainer) {
                            const noPosts = postsContainer.querySelector('.no-posts');
                            if (noPosts) noPosts.remove();
                            postsContainer.prepend(newPost);
                        }

                        form.reset();
                        closePostModal();
                        window.location.reload();
                    } else {
                        alert(result.message || "Something went wrong while creating the post.");
                    }
                } catch (error) {
                    console.error("Error creating post:", error);
                    alert("Failed to create post. Please try again.");
                }
            });
        }

        // Initial disable state
        if (submitPostBtn) submitPostBtn.disabled = true;
    });

        function performSearch() {
        const query = document.getElementById('searchPostsInput').value.toLowerCase();

        // Determine active tab
        const activeTab = document.querySelector('.community-tab.active')?.dataset?.tab;

        if (activeTab === "posts") {
            filterPosts(query);
        }
        else if (activeTab === "communities") {
            filterCommunities(query);
        }
    }

    function filterPosts(query) {
        const posts = document.querySelectorAll('.posts-only-list .post-card');
        let anyVisible = false;

        posts.forEach(post => {
            const title = post.dataset.title?.toLowerCase() || '';
            const content = post.querySelector('.post-card-content p')?.innerText.toLowerCase() || '';

            if (title.includes(query) || content.includes(query)) {
                post.style.display = 'block';
                anyVisible = true;
            } else {
                post.style.display = 'none';
            }
        });

        document.getElementById('noPostsFound').style.display = anyVisible ? 'none' : 'block';
    }

    function filterCommunities(query) {
        const list = document.querySelectorAll('.community-list-item'); // <— You confirm this class!
        let anyVisible = false;

        list.forEach(item => {
            const name = item.dataset.name?.toLowerCase() || '';
            const description = item.dataset.description?.toLowerCase() || '';

            if (name.includes(query) || description.includes(query)) {
                item.style.display = 'flex';
                anyVisible = true;
            } else {
                item.style.display = 'none';
            }
        });

        const noCommunities = document.getElementById('noCommunitiesFound');
        if (noCommunities) {
            noCommunities.style.display = anyVisible ? 'none' : 'block';
        }
    }

    const searchBtn = document.getElementById('searchPostsBtn');
    const searchInput = document.getElementById('searchPostsInput');

    if (searchBtn && searchInput) {
        searchBtn.addEventListener('click', performSearch);

        searchInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
    }

    // ================== TAB SWITCHING LOGIC ==================
    const tabs = document.querySelectorAll(".community-tab");
    const tabPanels = document.querySelectorAll(".community-tab-panel");

    if (tabs.length && tabPanels.length) {
        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                tabs.forEach(t => t.classList.remove("active"));
                tabPanels.forEach(panel => panel.classList.remove("active"));

                tab.classList.add("active");
                const selectedTab = tab.getAttribute("data-tab");
                const targetPanel = document.querySelector(`.community-tab-panel[data-tab="${selectedTab}"]`);
                if (targetPanel) targetPanel.classList.add("active");
            });
        });
    }
</script>